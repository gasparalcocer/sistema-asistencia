<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner UADY - Alumno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        #reader { width: 100%; min-height: 300px; background: #000; border-radius: 8px; }
        video { object-fit: cover; border-radius: 8px; }
        .stat-box { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

    <div id="pantalla-carga" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-900 mb-4"></div>
        <p class="text-blue-900 font-bold text-lg">Verificando sesiÃ³n...</p>
    </div>

    <div id="interfaz-principal" class="hidden w-full max-w-md">
        
        <div class="bg-white rounded-lg shadow-md p-4 mb-4 border-l-4 border-blue-900 flex justify-between items-center">
            <div>
                <p class="text-xs text-gray-500 uppercase">Bienvenido</p>
                <h2 id="user-nombre" class="text-lg font-bold text-gray-800 leading-tight">Cargando...</h2>
                <p id="user-matricula" class="text-sm text-blue-600 font-mono font-bold">...</p>
            </div>
            <button id="btn-cerrar-sesion" class="text-xs bg-red-50 text-red-600 px-3 py-2 rounded border border-red-100 hover:bg-red-100 font-bold transition">
                Salir
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-xl overflow-hidden">
            <div class="bg-blue-900 p-3 text-white text-center">
                <h1 class="text-lg font-bold">Registrar Asistencia</h1>
            </div>

            <div class="p-4">
                <div id="step-scan">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">1. Elige la materia</label>
                        <select id="select-materia" class="w-full p-3 border-2 border-blue-100 rounded-lg bg-gray-50 focus:border-blue-500 focus:outline-none text-gray-800 font-medium">
                            <option value="">-- Cargando materias... --</option>
                        </select>
                    </div>

                    <div id="panel-stats-previo" class="hidden mb-6 bg-gray-50 rounded-lg p-3 border border-gray-200 flex justify-between items-center stat-box">
                        <div>
                            <p class="text-xs text-gray-500 font-bold uppercase">Tu Asistencia Actual</p>
                            <p id="stat-previo-texto" class="text-xs text-gray-400">Calculando...</p>
                        </div>
                        <div class="text-right">
                            <span id="stat-previo-porc" class="text-2xl font-bold text-gray-700">--%</span>
                        </div>
                    </div>

                    <p class="text-xs font-bold text-gray-500 mb-2 uppercase">2. Escanea el cÃ³digo</p>
                    <div id="reader" class="mb-2"></div>
                    <div id="msg-status" class="mt-2 text-center text-sm font-bold text-gray-600">CÃ¡mara en espera...</div>
                </div>

                <div id="step-result" class="hidden text-center py-6">
                    <div id="icon-result" class="text-5xl mb-2"></div>
                    <h2 id="title-result" class="text-xl font-bold"></h2>
                    <p id="desc-result" class="text-gray-600 text-sm mb-6"></p>

                    <div class="bg-blue-50 rounded-xl p-4 mb-6 border border-blue-100 mx-auto max-w-xs shadow-inner">
                        <p class="text-xs text-blue-800 font-bold uppercase mb-1">Nueva EstadÃ­stica</p>
                        <div class="flex justify-center items-baseline gap-1">
                            <span id="stat-nuevo-porc" class="text-4xl font-bold text-blue-900">--%</span>
                            <span class="text-sm text-blue-600 font-bold">Total</span>
                        </div>
                        <p id="stat-nuevo-detalles" class="text-xs text-blue-400 mt-1">-- de -- sesiones asistidas</p>
                    </div>

                    <button onclick="location.reload()" class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition transform active:scale-95">
                        Escanear otra vez
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth, collection, addDoc, serverTimestamp } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACIÃ“N DE SEGURIDAD MEJORADA ---
        const DISTANCIA_MAXIMA_METROS = 200; 
        const TIEMPO_MAXIMO_QR_SEGUNDOS = 30; // Reducido de 120 a 30 segundos
        const LAT_SALON = 21.0483; 
        const LNG_SALON = -89.6433; 

        // Variables Globales
        let datosUsuario = { nombre: '', matricula: '' };
        let html5QrCode;

        // Elementos DOM
        const pantallaCarga = document.getElementById('pantalla-carga');
        const interfazPrincipal = document.getElementById('interfaz-principal');
        const selectMateria = document.getElementById('select-materia');
        const msgStatus = document.getElementById('msg-status');
        const panelStatsPrevio = document.getElementById('panel-stats-previo');

        // --- AUTH & LOAD ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const docSnap = await getDoc(doc(db, "usuarios", user.uid));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        datosUsuario = { nombre: data.nombre, matricula: data.matricula };
                        
                        document.getElementById('user-nombre').innerText = data.nombre;
                        document.getElementById('user-matricula').innerText = data.matricula || "Sin matrÃ­cula";
                        
                        await cargarListaMaterias();

                        pantallaCarga.classList.add('hidden');
                        interfazPrincipal.classList.remove('hidden');
                        iniciarCamara();
                    } else {
                        alert("Perfil no encontrado."); window.location.href = "login.html";
                    }
                } catch (e) { console.error(e); }
            } else { window.location.href = "login.html"; }
        });

        // --- HELPER: OBTENER HORA REAL DE INTERNET ---
        async function obtenerHoraInternet() {
            try {
                // Hacemos una peticiÃ³n ligera a nuestro propio servidor (Github Pages) para ver su hora
                // Esto evita que el alumno cambie la hora de su celular para engaÃ±ar al sistema.
                const response = await fetch(window.location.href, { method: 'HEAD', cache: 'no-store' });
                const serverDateStr = response.headers.get('date');
                if (serverDateStr) {
                    return new Date(serverDateStr).getTime();
                }
                throw new Error("No date header");
            } catch (e) {
                console.warn("No se pudo obtener hora de internet, usando local con advertencia.");
                return new Date().getTime(); // Fallback por si falla internet, pero el QR expira rÃ¡pido
            }
        }

        // --- CÃLCULO DE ESTADÃSTICAS ---
        async function calcularEstadisticas(materia) {
            document.getElementById('stat-previo-porc').innerText = "...";
            document.getElementById('stat-previo-texto').innerText = "Analizando historial...";
            
            try {
                const q = query(collection(db, "asistencias"), where("id_sesion", "==", materia));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    return { porcentaje: 100, asistidas: 0, totales: 0 };
                }

                const fechasTotales = new Set();
                const fechasAlumno = new Set();

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const fechaStr = d.timestamp.toDate().toISOString().split('T')[0];
                    fechasTotales.add(fechaStr);

                    if (d.alumno.matricula === datosUsuario.matricula) {
                        fechasAlumno.add(fechaStr);
                    }
                });

                const totalClases = fechasTotales.size;
                const totalAsistidas = fechasAlumno.size;
                let porcentaje = 100;
                
                if (totalClases > 0) {
                    porcentaje = Math.round((totalAsistidas / totalClases) * 100);
                }

                return { porcentaje, asistidas: totalAsistidas, totales: totalClases };

            } catch (e) {
                console.error("Error stats:", e);
                return null;
            }
        }

        // --- EVENTO AL SELECCIONAR MATERIA ---
        selectMateria.addEventListener('change', async () => {
            const materia = selectMateria.value;
            if (!materia) {
                panelStatsPrevio.classList.add('hidden');
                return;
            }

            panelStatsPrevio.classList.remove('hidden');
            const stats = await calcularEstadisticas(materia);
            
            if (stats) {
                const elPorc = document.getElementById('stat-previo-porc');
                elPorc.innerText = stats.porcentaje + "%";
                document.getElementById('stat-previo-texto').innerText = `${stats.asistidas} de ${stats.totales} clases`;
                elPorc.className = "text-2xl font-bold " + (stats.porcentaje < 80 ? "text-red-600" : "text-green-600");
            }
        });

        // --- SCANNER ---
        async function cargarListaMaterias() {
            selectMateria.innerHTML = '<option value="">-- Selecciona una materia --</option>';
            try {
                const snap = await getDocs(collection(db, "clases"));
                snap.forEach(d => {
                    const c = d.data();
                    selectMateria.add(new Option(c.nombre, c.nombre));
                });
            } catch (e) { console.error(e); }
        }

        document.getElementById('btn-cerrar-sesion').addEventListener('click', () => {
            if(confirm("Â¿Cerrar sesiÃ³n?")) signOut(auth).then(() => window.location.href = "index.html");
        });

        function iniciarCamara() {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, ()=>{});
        }

        async function onScanSuccess(decodedText) {
            const materia = selectMateria.value;
            if (!materia) return alert("âš ï¸ Selecciona una materia primero.");

            html5QrCode.pause();
            msgStatus.innerText = "Verificando hora de red...";
            
            try {
                const dataQR = JSON.parse(decodedText);
                
                // 1. VALIDACIÃ“N ANTI-FRAUDE DE TIEMPO
                const ahoraInternet = await obtenerHoraInternet();
                const diferenciaTiempo = (ahoraInternet - dataQR.t) / 1000;

                // ValidaciÃ³n estricta: No aceptamos QRs de mÃ¡s de 30 seg, ni QRs del futuro
                if (diferenciaTiempo > TIEMPO_MAXIMO_QR_SEGUNDOS) {
                    throw new Error("ðŸš« CÃ“DIGO CADUCADO<br>Este QR es antiguo. Escanea el que estÃ¡ en la pantalla ahora.");
                }
                if (diferenciaTiempo < -5) { // Tolerancia de 5s para relojes desfasados ligeramente
                    throw new Error("ðŸš« HORA INVÃLIDA<br>Tu reloj o el cÃ³digo tienen una hora incorrecta.");
                }

                if (dataQR.id !== materia) throw new Error(`QR Incorrecto.<br>Elegiste: <b>${materia}</b><br>QR es de: <b>${dataQR.id}</b>`);
                
                if (!navigator.geolocation) throw new Error("GPS requerido.");
                
                msgStatus.innerText = "Verificando ubicaciÃ³n...";

                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const dist = calcularDistancia(LAT_SALON, LNG_SALON, pos.coords.latitude, pos.coords.longitude);
                    if (dist > DISTANCIA_MAXIMA_METROS) {
                        mostrarResultado(false, "UbicaciÃ³n Incorrecta", `EstÃ¡s a ${dist.toFixed(0)}m del salÃ³n.`);
                    } else {
                        // GUARDAR
                        msgStatus.innerText = "Registrando...";
                        await addDoc(collection(db, "asistencias"), {
                            id_sesion: dataQR.id, qr_token: dataQR.t, alumno: datosUsuario,
                            ubicacion: { lat: pos.coords.latitude, lng: pos.coords.longitude },
                            timestamp: serverTimestamp(), dispositivo: navigator.userAgent
                        });

                        msgStatus.innerText = "Actualizando estadÃ­sticas...";
                        const stats = await calcularEstadisticas(materia);
                        mostrarResultado(true, "Â¡Asistencia Registrada!", `Clase: ${materia}`, stats);
                        html5QrCode.stop();
                    }
                }, () => mostrarResultado(false, "Error GPS", "Activa ubicaciÃ³n."));
            } catch (e) { mostrarResultado(false, "Error", e.message); }
        }

        function mostrarResultado(exito, titulo, desc, stats = null) {
            document.getElementById('step-scan').classList.add('hidden');
            document.getElementById('step-result').classList.remove('hidden');
            
            const icon = document.getElementById('icon-result');
            const title = document.getElementById('title-result');
            const txt = document.getElementById('desc-result');

            if(exito) {
                icon.innerHTML = "âœ…"; icon.className = "text-5xl mb-2 text-green-500";
                title.className = "text-xl font-bold text-green-700";
                
                if (stats) {
                    const elPorc = document.getElementById('stat-nuevo-porc');
                    elPorc.innerText = stats.porcentaje + "%";
                    elPorc.className = "text-4xl font-bold " + (stats.porcentaje < 80 ? "text-red-500" : "text-blue-900");
                    document.getElementById('stat-nuevo-detalles').innerText = `${stats.asistidas} de ${stats.totales} clases asistidas`;
                }
            } else {
                icon.innerHTML = "âŒ"; icon.className = "text-5xl mb-2 text-red-500";
                title.className = "text-xl font-bold text-red-700";
                document.querySelector('.bg-blue-50').classList.add('hidden');
            }
            title.innerText = titulo;
            txt.innerHTML = desc;
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
