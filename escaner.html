<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner UADY - Alumno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        #reader { width: 100%; min-height: 300px; background: #000; border-radius: 8px; }
        video { object-fit: cover; border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

    <div id="pantalla-carga" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-900 mb-4"></div>
        <p class="text-blue-900 font-bold">Cargando tu perfil...</p>
    </div>

    <div id="interfaz-principal" class="hidden w-full max-w-md">
        
        <div class="bg-white rounded-lg shadow-md p-4 mb-4 border-l-4 border-blue-900">
            <p class="text-xs text-gray-500 uppercase">Bienvenido, Alumno</p>
            <h2 id="user-nombre" class="text-lg font-bold text-gray-800">Cargando...</h2>
            <p id="user-matricula" class="text-sm text-blue-600 font-mono font-bold">...</p>
        </div>

        <div class="bg-white rounded-lg shadow-xl overflow-hidden">
            <div class="bg-blue-900 p-3 text-white text-center flex justify-between items-center">
                <h1 class="text-lg font-bold">Escaner de Asistencia</h1>
                <button id="btn-cerrar-sesion" class="text-xs bg-red-500 px-2 py-1 rounded hover:bg-red-600">Salir</button>
            </div>

            <div class="p-4">
                <div id="step-scan">
                    <p class="text-xs text-center text-gray-500 mb-2">Apunta al código QR del profesor</p>
                    <div id="reader"></div>
                    <div id="msg-status" class="mt-4 text-center text-sm font-bold text-gray-600">Cámara lista</div>
                </div>

                <div id="step-result" class="hidden text-center py-6">
                    <div id="icon-result" class="text-5xl mb-2"></div>
                    <h2 id="title-result" class="text-xl font-bold"></h2>
                    <p id="desc-result" class="text-gray-600 text-sm"></p>
                    <button onclick="location.reload()" class="mt-6 text-blue-600 underline text-sm">Escanear otro</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth, collection, addDoc, serverTimestamp } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACIÓN ---
        const DISTANCIA_MAXIMA_METROS = 200; 
        const TIEMPO_MAXIMO_QR_SEGUNDOS = 120;
        // Coordenadas UADY (FIUADY)
        const LAT_SALON = 21.0483; 
        const LNG_SALON = -89.6433; 

        // Variables Globales del Usuario
        let datosUsuario = { nombre: '', matricula: '' };
        let html5QrCode;

        // Elementos DOM
        const pantallaCarga = document.getElementById('pantalla-carga');
        const interfazPrincipal = document.getElementById('interfaz-principal');
        const txtNombre = document.getElementById('user-nombre');
        const txtMatricula = document.getElementById('user-matricula');
        const stepScan = document.getElementById('step-scan');
        const stepResult = document.getElementById('step-result');
        const msgStatus = document.getElementById('msg-status');

        // 1. VERIFICAR SESIÓN Y CARGAR DATOS
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Buscar datos extra en Firestore (nombre, matricula)
                    const docSnap = await getDoc(doc(db, "usuarios", user.uid));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        datosUsuario.nombre = data.nombre;
                        datosUsuario.matricula = data.matricula;
                        
                        // Mostrar en interfaz
                        txtNombre.innerText = datosUsuario.nombre;
                        txtMatricula.innerText = datosUsuario.matricula;
                        
                        // Mostrar interfaz
                        pantallaCarga.classList.add('hidden');
                        interfazPrincipal.classList.remove('hidden');
                        
                        // Iniciar cámara automáticamente
                        iniciarCamara();
                    } else {
                        alert("Error: Perfil de usuario incompleto.");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error al cargar perfil.");
                }
            } else {
                window.location.href = "login.html";
            }
        });

        // Botón Cerrar Sesión
        document.getElementById('btn-cerrar-sesion').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "index.html");
        });

        function iniciarCamara() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (err)=>{})
            .catch(err => {
                msgStatus.innerText = "Error: No se pudo abrir la cámara trasera.";
                // Intentar cámara frontal si falla
                html5QrCode.start({ facingMode: "user" }, config, onScanSuccess, (err)=>{});
            });
        }

        async function onScanSuccess(decodedText) {
            html5QrCode.pause(); // Congelar cámara
            msgStatus.innerText = "Procesando código...";
            
            try {
                const dataQR = JSON.parse(decodedText);

                // 1. Validar Tiempo
                const ahora = new Date().getTime();
                if ((ahora - dataQR.t) / 1000 > TIEMPO_MAXIMO_QR_SEGUNDOS) throw new Error("El código QR ha caducado.");

                // 2. Validar GPS
                if (!navigator.geolocation) throw new Error("Tu dispositivo no tiene GPS.");
                
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const dist = calcularDistancia(LAT_SALON, LNG_SALON, pos.coords.latitude, pos.coords.longitude);
                    
                    if (dist > DISTANCIA_MAXIMA_METROS) {
                        mostrarResultado(false, "Ubicación Incorrecta", `Estás a ${dist.toFixed(0)}m del salón.`);
                    } else {
                        // ENVIAR A FIREBASE
                        await addDoc(collection(db, "asistencias"), {
                            id_sesion: dataQR.id,
                            qr_token: dataQR.t,
                            alumno: datosUsuario, // <--- Usamos los datos cargados del perfil
                            ubicacion: { lat: pos.coords.latitude, lng: pos.coords.longitude },
                            timestamp: serverTimestamp(),
                            dispositivo: navigator.userAgent
                        });
                        mostrarResultado(true, "Asistencia Registrada", "Tus datos se guardaron correctamente.");
                        html5QrCode.stop();
                    }
                }, (err) => {
                    mostrarResultado(false, "Error GPS", "Debes activar tu ubicación.");
                });

            } catch (e) {
                mostrarResultado(false, "Error", e.message);
            }
        }

        function mostrarResultado(exito, titulo, desc) {
            stepScan.classList.add('hidden');
            stepResult.classList.remove('hidden');
            
            const icon = document.getElementById('icon-result');
            const title = document.getElementById('title-result');
            const txt = document.getElementById('desc-result');

            if(exito) {
                icon.innerHTML = "✅";
                icon.className = "text-5xl mb-2 text-green-500";
                title.innerText = titulo;
                title.className = "text-xl font-bold text-green-700";
            } else {
                icon.innerHTML = "❌";
                icon.className = "text-5xl mb-2 text-red-500";
                title.innerText = titulo;
                title.className = "text-xl font-bold text-red-700";
            }
            txt.innerText = desc;
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180, Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
