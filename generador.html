<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Docente - UADY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        .tab-active { border-bottom: 3px solid #1e3a8a; color: #1e3a8a; font-weight: 800; background-color: #eff6ff; }
        .tab-inactive { color: #6b7280; hover:bg-gray-50; }
        .table-matrix th, .table-matrix td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; font-size: 0.85rem; }
        .bg-cell-present { background-color: #dcfce7; color: #166534; font-weight: bold; } 
        .bg-cell-absent { background-color: #fee2e2; color: #991b1b; }
        .bg-cell-justified { background-color: #fef9c3; color: #854d0e; font-weight: bold; }
        @keyframes highlight {
            0% { background-color: #fef08a; transform: scale(1.02); }
            100% { background-color: white; transform: scale(1); }
        }
        .nuevo-registro { animation: highlight 2s ease-out; }
    </style>
</head>
<body id="main-body" class="bg-gray-100 min-h-screen font-sans" style="display: none;">

    <div id="loader" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-900 mb-4"></div>
        <p class="text-blue-900 font-bold">Cargando Panel Docente...</p>
    </div>

    <nav class="bg-blue-900 text-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="h-8 w-8 bg-white rounded-full flex items-center justify-center text-blue-900 font-bold">U</div>
                <span class="font-bold text-lg">Docente UADY</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="nav-email" class="text-xs text-blue-200 hidden md:block"></span>
                <button id="btn-logout" class="bg-red-600 hover:bg-red-700 text-white text-xs py-2 px-4 rounded font-bold transition">
                    CERRAR SESI√ìN
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4">
        
        <div class="flex flex-wrap border-b border-gray-300 mb-6 bg-white rounded-lg px-2 pt-2 shadow-sm overflow-x-auto">
            <button onclick="cambiarTab('qr')" id="tab-qr" class="tab-active flex-1 py-3 px-4 focus:outline-none transition whitespace-nowrap">Generar QR</button>
            <button onclick="cambiarTab('historial')" id="tab-historial" class="tab-inactive flex-1 py-3 px-4 focus:outline-none transition whitespace-nowrap">Historial</button>
            <button onclick="cambiarTab('reporte')" id="tab-reporte" class="tab-inactive flex-1 py-3 px-4 focus:outline-none transition whitespace-nowrap text-blue-700 font-bold">üìä S√°bana</button>
            <button onclick="cambiarTab('alumnos')" id="tab-alumnos" class="tab-inactive flex-1 py-3 px-4 focus:outline-none transition whitespace-nowrap font-bold text-gray-700">üë• Mis Alumnos</button>
            <button onclick="cambiarTab('clases')" id="tab-clases" class="tab-inactive flex-1 py-3 px-4 focus:outline-none transition whitespace-nowrap">Admin. Clases</button>
        </div>

        <div id="view-qr" class="view-section">
            <div class="bg-white p-6 rounded-lg shadow max-w-4xl mx-auto border-t-4 border-blue-900">
                <div id="config-qr-container" class="text-center py-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Pasar Lista</h2>
                    <div class="max-w-md mx-auto">
                        <select id="select-clase-qr" class="w-full p-3 border rounded bg-gray-50 mb-4"></select>
                        <button id="btn-iniciar-qr" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition shadow-lg text-lg">INICIAR CLASE</button>
                    </div>
                </div>

                <div id="panel-qr-activo" class="hidden">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 id="titulo-clase-activa" class="text-2xl font-bold text-blue-900"></h3>
                        <button onclick="detenerClase()" class="bg-red-100 text-red-700 px-4 py-2 rounded font-bold text-sm">‚èπ Terminar</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="flex flex-col items-center p-4">
                            <canvas id="qrcode" class="bg-white p-2 rounded shadow-lg border mb-4"></canvas>
                            <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full mb-6">Cambia en: <span id="contador" class="font-bold text-blue-600">10</span>s</div>
                            <div class="w-full bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h4 class="text-sm font-bold text-yellow-800 mb-2">‚úçÔ∏è Registro R√°pido</h4>
                                <div class="flex gap-2">
                                    <input type="text" id="manual-matricula" placeholder="Matr√≠cula" class="w-full p-2 text-sm border rounded uppercase">
                                    <button onclick="registrarManual()" class="bg-yellow-600 text-white px-4 py-2 rounded font-bold">OK</button>
                                </div>
                                <p id="manual-status" class="text-xs mt-1 text-gray-400 italic h-4"></p>
                            </div>
                        </div>
                        <div class="flex flex-col h-[500px]">
                            <div class="flex justify-between items-end mb-2">
                                <h4 class="font-bold text-gray-700">Asistentes en Sala</h4>
                                <span id="contador-vivo" class="bg-green-100 text-green-800 text-2xl font-bold px-3 py-1 rounded-lg">0</span>
                            </div>
                            <ul id="lista-asistentes-vivo" class="overflow-y-auto p-2 space-y-2 border rounded bg-gray-50 flex-1">
                                <li class="text-center text-gray-400 text-sm py-10 italic" id="msg-esperando">Esperando registros...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-historial" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Bit√°cora Diaria</h2>
                    <button onclick="exportarCSV()" class="bg-green-600 text-white px-4 py-2 rounded font-bold text-sm">üì• Descargar CSV</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select id="filtro-clase" class="p-2 border rounded text-sm"></select>
                    <input type="date" id="filtro-fecha" class="p-2 border rounded text-sm">
                    <button onclick="consultarAsistencias()" class="bg-blue-900 text-white py-2 rounded text-sm font-bold">Buscar</button>
                </div>
                <div class="overflow-x-auto border rounded">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr><th>Fecha</th><th>Hora</th><th>Alumno</th><th>Matr√≠cula</th><th>Estado</th></tr>
                        </thead>
                        <tbody id="tabla-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-reporte" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-xl font-bold text-blue-900">üìä Reporte Global</h2>
                    <div class="flex gap-2">
                        <select id="select-clase-reporte" class="p-2 border rounded text-sm min-w-[200px]"></select>
                        <button onclick="generarMatrizAsistencia()" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold">Generar</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[500px] border rounded">
                    <table class="w-full table-matrix border-collapse relative">
                        <thead id="matriz-head" class="bg-gray-100 sticky top-0 z-20 shadow-sm"></thead>
                        <tbody id="matriz-body"></tbody>
                    </table>
                </div>
                <p id="msg-reporte" class="text-center text-sm text-gray-400 mt-4"></p>
            </div>
        </div>

        <div id="view-alumnos" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">üë• Lista de Alumnos</h2>
                        <p class="text-sm text-gray-500">Administra las inscripciones por materia.</p>
                    </div>
                    
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="select-clase-alumnos" class="p-2 border-2 border-blue-100 rounded text-sm flex-grow md:min-w-[250px] focus:border-blue-500 outline-none">
                            <option value="">-- Selecciona una Materia --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <div class="overflow-hidden border rounded-lg">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3">Matr√≠cula</th>
                                        <th class="px-4 py-3">Nombre</th>
                                        <th class="px-4 py-3 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-alumnos-inscritos">
                                    <tr><td colspan="3" class="text-center py-8 text-gray-400">Selecciona una materia arriba para ver a los alumnos.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <p id="contador-alumnos" class="text-xs text-gray-400 mt-2 text-right"></p>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg h-fit border border-blue-100">
                        <h3 class="font-bold text-blue-900 mb-3 text-sm">‚ûï Dar de Alta Alumno</h3>
                        <p class="text-xs text-blue-800 mb-3">Agrega un alumno individualmente a esta materia.</p>
                        <div class="space-y-3">
                            <input type="text" id="alta-matricula" placeholder="Matr√≠cula (Ej: A1234)" class="w-full p-2 border rounded text-sm uppercase">
                            <input type="text" id="alta-nombre" placeholder="Nombre Completo" class="w-full p-2 border rounded text-sm uppercase">
                            <button onclick="darAltaManual()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm hover:bg-blue-700 shadow">Agregar a la Lista</button>
                        </div>
                        <div id="alta-status" class="mt-2 text-xs font-bold text-center"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-clases" class="view-section hidden">
            
            <div class="bg-white p-6 rounded-lg shadow border-t-4 border-orange-500 mb-6">
                <h2 class="text-lg font-bold text-gray-800 mb-2">üì• Importador Masivo de Alumnos</h2>
                <p class="text-xs text-gray-500 mb-3">1. Selecciona la asignatura. 2. Pega la lista (Excel o Texto).</p>
                
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-700 mb-1">Asignatura Destino:</label>
                    <select id="select-clase-importar" class="w-full p-2 border-2 border-orange-200 rounded bg-orange-50 text-sm font-bold text-gray-700 focus:border-orange-500 outline-none">
                        <option value="">-- Selecciona d√≥nde inscribir a los alumnos --</option>
                    </select>
                </div>

                <textarea id="excel-data" rows="4" class="w-full p-3 border-2 border-dashed rounded-lg font-mono text-xs mb-3 focus:outline-none focus:border-orange-400" placeholder="21203824-VALERIA YOLANDA&#10;A12345678	JUAN PEREZ"></textarea>
                
                <div class="flex justify-between items-center">
                    <span id="import-status" class="text-xs font-bold italic text-gray-500">Esperando datos...</span>
                    <button onclick="importarAlumnos()" class="bg-orange-600 text-white px-6 py-2 rounded font-bold hover:bg-orange-700 transition shadow">
                        PROCESAR E INSCRIBIR
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow border-t-4 border-blue-500 mb-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">‚öñÔ∏è Justificar Falta (Retroactivo)</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <input type="text" id="just-matricula" placeholder="Matr√≠cula" class="p-2 border rounded text-sm uppercase">
                    <input type="date" id="just-fecha" class="p-2 border rounded text-sm">
                    <select id="select-clase-justificar" class="p-2 border rounded text-sm"></select>
                    <input type="text" id="just-nota" placeholder="Observaciones" class="p-2 border rounded text-sm">
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="guardarJustificacion()" class="bg-blue-800 text-white px-6 py-2 rounded font-bold text-sm shadow-md">Aplicar Justificaci√≥n</button>
                </div>
                <p id="just-status" class="text-xs mt-2 italic text-gray-400"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow border-t-4 border-green-600">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">‚ûï Nueva Materia</h2>
                    <form id="form-add-clase" class="space-y-3">
                        <input type="text" id="nueva-clase-nombre" placeholder="Nombre de la Materia" required class="w-full p-2 border rounded">
                        <input type="text" id="nueva-clase-id" placeholder="C√≥digo" class="w-full p-2 border rounded">
                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded font-bold">Guardar</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">üìö Mis Materias</h2>
                    <ul id="lista-clases" class="space-y-2"></ul>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth, db, collection, addDoc, serverTimestamp } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, getDocs, setDoc, query, where, orderBy, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let usuarioActual = null;
        let intervaloQR;
        let qrGenerator;
        let claseActiva = null;
        let unsubscribeLive = null;
        let asistentesVivos = 0;

        // Gesti√≥n de Pesta√±as
        window.cambiarTab = (tabName) => {
            if (claseActiva && tabName !== 'qr') {
                if(!confirm("Cerrar√°s la sesi√≥n de asistencia actual. ¬øContinuar?")) return;
                detenerClase();
            }
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => { 
                btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); 
            });
            document.getElementById(`tab-${tabName}`).classList.replace('tab-inactive', 'tab-active');
        };

        // Autenticaci√≥n
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docSnap = await getDoc(doc(db, "usuarios", user.uid));
                if (docSnap.exists() && docSnap.data().rol === "profesor") {
                    usuarioActual = user;
                    document.getElementById('nav-email').innerText = user.email;
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('main-body').style.display = "block";
                    await cargarClases(); // Carga las materias en todos los selects
                    qrGenerator = new QRious({ element: document.getElementById('qrcode'), size: 250 });
                    
                    // Listener para cambio de materia en la pesta√±a de alumnos
                    document.getElementById('select-clase-alumnos').addEventListener('change', (e) => cargarAlumnosDeMateria(e.target.value));

                } else { window.location.href = "index.html"; }
            } else { window.location.href = "login.html"; }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth).then(() => window.location.href = "index.html"));

        // ==========================================
        // 1. IMPORTADOR Y GESTI√ìN DE ALUMNOS
        // ==========================================

        window.importarAlumnos = async () => {
            const rawData = document.getElementById('excel-data').value.trim();
            const claseId = document.getElementById('select-clase-importar').value;
            const status = document.getElementById('import-status');

            if (!claseId) return alert("‚ö†Ô∏è ¬°ALERTA! Debes seleccionar una asignatura destino para inscribir a los alumnos.");
            if (!rawData) return alert("Pega los datos de los alumnos.");

            status.innerText = "‚è≥ Procesando e inscribiendo...";
            const filas = rawData.split('\n');
            let count = 0;
            let errores = 0;

            for (let fila of filas) {
                let m = "", n = "";
                // Detecci√≥n de formato
                if (fila.includes('-')) {
                    const p = fila.split('-'); m = p[0].trim(); n = p.slice(1).join('-').trim();
                } else if (fila.includes('\t')) {
                    const p = fila.split('\t'); m = p[0].trim(); n = p[1].trim();
                }

                if (m && n) {
                    try {
                        const matricula = m.toUpperCase();
                        const nombre = n.toUpperCase();

                        // PASO 1: Agregar al Padr√≥n Global (Lista blanca)
                        await setDoc(doc(db, "padron_alumnos", matricula), {
                            nombre_oficial: nombre,
                            matricula: matricula,
                            fecha_actualizacion: serverTimestamp()
                        });

                        // PASO 2: Inscribir en la Asignatura Espec√≠fica (Nueva colecci√≥n 'inscripciones')
                        // Creamos un ID √∫nico compuesto: IDClase_Matricula
                        const inscripcionId = `${claseId}_${matricula}`;
                        await setDoc(doc(db, "inscripciones", inscripcionId), {
                            clase_id: claseId,
                            matricula: matricula,
                            nombre_alumno: nombre,
                            fecha_inscripcion: serverTimestamp()
                        });

                        count++;
                    } catch (e) {
                        console.error(e);
                        errores++;
                    }
                }
            }
            status.innerText = `‚úÖ ${count} alumnos inscritos en la materia. (${errores} errores)`;
            document.getElementById('excel-data').value = "";
            alert(`Proceso finalizado. ${count} alumnos se han vinculado a la asignatura.`);
        };

        // Funci√≥n para cargar la tabla en la pesta√±a "Administrar Alumnos"
        window.cargarAlumnosDeMateria = async (claseId) => {
            const tbody = document.getElementById('lista-alumnos-inscritos');
            const contador = document.getElementById('contador-alumnos');
            
            if (!claseId) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-400">Selecciona una materia.</td></tr>';
                contador.innerText = "";
                return;
            }

            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-blue-500 font-bold">Cargando lista...</td></tr>';

            try {
                // Buscamos en la colecci√≥n 'inscripciones'
                const q = query(collection(db, "inscripciones"), where("clase_id", "==", claseId));
                const snap = await getDocs(q);
                
                // Ordenamiento manual por nombre (para evitar requerir √≠ndice compuesto inmediatamente)
                let alumnos = [];
                snap.forEach(doc => {
                    alumnos.push({ id: doc.id, ...doc.data() });
                });
                
                alumnos.sort((a, b) => a.nombre_alumno.localeCompare(b.nombre_alumno));

                if (alumnos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-400 italic">No hay alumnos inscritos en esta materia.</td></tr>';
                    contador.innerText = "Total: 0 alumnos";
                    return;
                }

                tbody.innerHTML = "";
                alumnos.forEach(alum => {
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50 transition">
                            <td class="px-4 py-3 font-mono text-xs font-bold text-gray-600">${alum.matricula}</td>
                            <td class="px-4 py-3 font-bold text-gray-800">${alum.nombre_alumno}</td>
                            <td class="px-4 py-3 text-right">
                                <button onclick="darBajaAlumno('${alum.id}')" class="text-red-500 hover:text-red-700 font-bold text-xs bg-red-50 hover:bg-red-100 px-3 py-1 rounded border border-red-200 transition">
                                    Dar de Baja
                                </button>
                            </td>
                        </tr>
                    `;
                });
                contador.innerText = `Total: ${alumnos.length} alumnos inscritos`;

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-red-500">Error al cargar: ${e.message}</td></tr>`;
            }
        };

        // Funci√≥n para Dar de Baja (Eliminar inscripci√≥n)
        window.darBajaAlumno = async (inscripcionId) => {
            if(confirm("¬øEst√°s seguro de dar de baja a este alumno de esta materia?")) {
                try {
                    await deleteDoc(doc(db, "inscripciones", inscripcionId));
                    // Recargar la lista
                    const claseActual = document.getElementById('select-clase-alumnos').value;
                    cargarAlumnosDeMateria(claseActual);
                } catch (e) { alert("Error: " + e.message); }
            }
        };

        // Funci√≥n para Dar de Alta Manualmente (Individual)
        window.darAltaManual = async () => {
            const claseId = document.getElementById('select-clase-alumnos').value;
            const mat = document.getElementById('alta-matricula').value.trim().toUpperCase();
            const nom = document.getElementById('alta-nombre').value.trim().toUpperCase();
            const status = document.getElementById('alta-status');

            if (!claseId) return alert("Selecciona una materia primero.");
            if (!mat || !nom) return alert("Escribe matr√≠cula y nombre.");

            status.innerText = "Guardando...";
            try {
                // 1. Padr√≥n Global
                await setDoc(doc(db, "padron_alumnos", mat), {
                    nombre_oficial: nom,
                    matricula: mat,
                    fecha_actualizacion: serverTimestamp()
                });
                
                // 2. Inscripci√≥n
                const inscripcionId = `${claseId}_${mat}`;
                await setDoc(doc(db, "inscripciones", inscripcionId), {
                    clase_id: claseId,
                    matricula: mat,
                    nombre_alumno: nom,
                    fecha_inscripcion: serverTimestamp()
                });

                status.innerText = "‚úÖ Alumno agregado.";
                document.getElementById('alta-matricula').value = "";
                document.getElementById('alta-nombre').value = "";
                cargarAlumnosDeMateria(claseId); // Recargar tabla
                setTimeout(() => status.innerText = "", 3000);

            } catch (e) { status.innerText = "‚ùå Error: " + e.message; }
        };

        // ==========================================
        // 2. L√ìGICA DE JUSTIFICACI√ìN Y ASISTENCIA
        // ==========================================
        window.guardarJustificacion = async () => {
            const mat = document.getElementById('just-matricula').value.toUpperCase().trim();
            const fecha = document.getElementById('just-fecha').value;
            const materia = document.getElementById('select-clase-justificar').value;
            const nota = document.getElementById('just-nota').value.trim();
            const status = document.getElementById('just-status');

            if(!mat || !fecha || !materia) return alert("Completa los campos obligatorios");
            status.innerText = "‚è≥ Aplicando...";

            try {
                const pSnap = await getDoc(doc(db, "padron_alumnos", mat));
                let nombre = "ALUMNO NO EN PADR√ìN";
                if(pSnap.exists()) nombre = pSnap.data().nombre_oficial;

                await addDoc(collection(db, "asistencias"), {
                    id_sesion: materia,
                    alumno: { nombre: nombre, matricula: mat },
                    timestamp: new Date(fecha + "T12:00:00"),
                    tipo: "justificado",
                    ubicacion: { manual: true, nota: nota || "Justificaci√≥n docente" }
                });
                status.innerText = "‚úÖ Justificaci√≥n aplicada.";
                document.getElementById('just-matricula').value = "";
            } catch (e) { status.innerText = "‚ùå Error: " + e.message; }
        };

        // ==========================================
        // 3. CORE (QR, MATERIAS, MONITOR)
        // ==========================================
        
        document.getElementById('btn-iniciar-qr').addEventListener('click', () => {
            const m = document.getElementById('select-clase-qr').value;
            if(!m) return;
            claseActiva = m;
            document.getElementById('titulo-clase-activa').innerText = m;
            document.getElementById('config-qr-container').classList.add('hidden');
            document.getElementById('panel-qr-activo').classList.remove('hidden');
            generarQR();
            intervaloQR = setInterval(() => {
                let s = parseInt(document.getElementById('contador').innerText) - 1;
                document.getElementById('contador').innerText = s <= 0 ? (generarQR(), 10) : s;
            }, 1000);
            iniciarMonitorEnVivo(m);
        });

        function iniciarMonitorEnVivo(m) {
            const lista = document.getElementById('lista-asistentes-vivo');
            const cont = document.getElementById('contador-vivo');
            const q = query(collection(db, "asistencias"), where("id_sesion", "==", m), where("timestamp", ">=", new Date()), orderBy("timestamp", "desc"));
            unsubscribeLive = onSnapshot(q, (snap) => {
                snap.docChanges().forEach(c => {
                    if (c.type === "added") {
                        const d = c.doc.data();
                        document.getElementById('msg-esperando')?.remove();
                        asistentesVivos++;
                        cont.innerText = asistentesVivos;
                        const li = document.createElement('li');
                        li.id = `asist-${c.doc.id}`;
                        li.className = "flex justify-between items-center p-3 rounded shadow-sm border-l-4 bg-white border-green-500 nuevo-registro";
                        li.innerHTML = `<div><p class="font-bold text-sm uppercase">${d.alumno.nombre}</p><p class="text-xs text-gray-400">${d.alumno.matricula}</p></div><button onclick="eliminarRegistro('${c.doc.id}')" class="text-red-400">üóëÔ∏è</button>`;
                        lista.prepend(li);
                    }
                    if (c.type === "removed") {
                        document.getElementById(`asist-${c.doc.id}`)?.remove();
                        asistentesVivos--; cont.innerText = asistentesVivos;
                    }
                });
            });
        }

        window.eliminarRegistro = async (id) => confirm("¬øEliminar registro?") && await deleteDoc(doc(db, "asistencias", id));

        window.detenerClase = () => {
            clearInterval(intervaloQR);
            unsubscribeLive?.();
            document.getElementById('panel-qr-activo').classList.add('hidden');
            document.getElementById('config-qr-container').classList.remove('hidden');
            document.getElementById('lista-asistentes-vivo').innerHTML = '<li id="msg-esperando" class="text-center py-10 italic">Esperando registros...</li>';
            asistentesVivos = 0; document.getElementById('contador-vivo').innerText = "0";
            claseActiva = null;
        };

        function generarQR() {
            qrGenerator.value = JSON.stringify({ id: claseActiva, t: Date.now(), s: Math.random().toString(36).substr(2, 5) });
        }

        async function cargarClases() {
            const list = document.getElementById('lista-clases');
            // Lista de todos los selects que necesitan llenarse con las materias
            const sels = [
                document.getElementById('select-clase-qr'), 
                document.getElementById('filtro-clase'), 
                document.getElementById('select-clase-reporte'),
                document.getElementById('select-clase-justificar'),
                document.getElementById('select-clase-importar'), // <--- Select del Importador
                document.getElementById('select-clase-alumnos')   // <--- Select de la nueva pesta√±a
            ];
            list.innerHTML = ""; sels.forEach(s => s.innerHTML = '<option value="">-- Selecciona Materia --</option>');
            
            const q = query(collection(db, "clases"), where("profesor_uid", "==", usuarioActual.uid));
            const snap = await getDocs(q);
            
            snap.forEach(d => {
                const data = d.data();
                list.innerHTML += `<li class="flex justify-between bg-gray-50 p-3 rounded border"><span><b>${data.nombre}</b></span><button onclick="eliminarClase('${d.id}')" class="text-red-500 text-xs">Eliminar</button></li>`;
                sels.forEach(s => s.add(new Option(data.nombre, data.nombre))); // Usamos el nombre como ID para simplicidad
            });
        }

        document.getElementById('form-add-clase').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "clases"), { 
                nombre: document.getElementById('nueva-clase-nombre').value, 
                profesor_uid: usuarioActual.uid 
            });
            cargarClases();
            e.target.reset();
        });

        window.eliminarClase = async (id) => { if(confirm("¬øEliminar materia?")) { await deleteDoc(doc(db, "clases", id)); cargarClases(); } };

        // S√°bana de Asistencias (Matriz)
        window.generarMatrizAsistencia = async () => {
            const m = document.getElementById('select-clase-reporte').value;
            const head = document.getElementById('matriz-head');
            const body = document.getElementById('matriz-body');
            if(!m) return;
            body.innerHTML = '<tr><td colspan="10" class="p-4">Cargando...</td></tr>';
            const q = query(collection(db, "asistencias"), where("id_sesion", "==", m));
            const snap = await getDocs(q);
            const fechas = new Set(), alumnos = {};
            snap.forEach(doc => {
                const d = doc.data(); const f = d.timestamp.toDate().toISOString().split('T')[0];
                fechas.add(f);
                if(!alumnos[d.alumno.matricula]) alumnos[d.alumno.matricula] = { n: d.alumno.nombre, a: {} };
                alumnos[d.alumno.matricula].a[f] = d.tipo || "presente";
            });
            const fechasArr = Array.from(fechas).sort();
            head.innerHTML = `<tr><th class="p-2 text-left sticky left-0 bg-gray-100">Alumno</th><th class="p-2">%</th>${fechasArr.map(f => `<th class="p-2">${f.slice(5)}</th>`).join('')}</tr>`;
            body.innerHTML = Object.keys(alumnos).sort().map(mat => {
                const al = alumnos[mat]; const asis = Object.keys(al.a).length;
                const p = Math.round((asis/fechasArr.length)*100);
                return `<tr><td class="p-2 text-left sticky left-0 bg-white font-bold">${al.n}</td><td class="p-2 font-bold">${p}%</td>${fechasArr.map(f => {
                    const e = al.a[f];
                    return `<td class="${e==='presente'?'bg-cell-present':(e==='justificado'?'bg-cell-justified':'bg-cell-absent')}">${e==='presente'?'1':(e==='justificado'?'J':'0')}</td>`;
                }).join('')}</tr>`;
            }).join('');
        };

        // Historial simple
        window.consultarAsistencias = async () => {
            const filtroClase = document.getElementById('filtro-clase').value;
            const filtroFecha = document.getElementById('filtro-fecha').value;
            const tbody = document.getElementById('tabla-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-blue-500">Buscando...</td></tr>';
            try {
                let q = query(collection(db, "asistencias"), orderBy("timestamp", "desc"));
                if (filtroClase) q = query(collection(db, "asistencias"), where("id_sesion", "==", filtroClase), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                tbody.innerHTML = ""; let count=0;
                snap.forEach(doc => {
                    const data = doc.data();
                    const fechaObj = data.timestamp.toDate();
                    let fechaFiltro = fechaObj.toISOString().split('T')[0];
                    if (!filtroFecha || filtroFecha === fechaFiltro) {
                        count++;
                        const badge = data.tipo === "justificado" ? 
                            '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold">Justificado</span>' : 
                            '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">Presente</span>';
                        tbody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-4 py-2">${fechaObj.toLocaleDateString()}</td><td class="px-4 py-2 font-mono text-xs">${fechaObj.toLocaleTimeString()}</td><td class="px-4 py-2 font-bold text-gray-700">${data.alumno.nombre}</td><td class="px-4 py-2">${data.alumno.matricula}</td><td class="px-4 py-2">${badge}</td></tr>`;
                    }
                });
                if(count===0) tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No hay datos.</td></tr>';
            } catch (e) { tbody.innerHTML=`<tr><td colspan="5" class="text-center text-red-500">Error: ${e.message}</td></tr>`; }
        };

        window.exportarCSV = () => {
            const rows = document.querySelectorAll('#tabla-body tr');
            if (rows.length === 0 || rows[0].innerText.includes('No hay datos')) return alert("Sin datos.");
            let csvContent = "\uFEFFFecha,Hora,Alumno,Matricula,Estado\n";
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length > 1) { csvContent += Array.from(cols).map(col => `"${col.innerText}"`).join(",") + "\n"; }
            });
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })); link.download = `Reporte_${new Date().toISOString().split('T')[0]}.csv`; link.click();
        };
// Agrega esto al final de tu <script type="module">
window.registrarManual = async () => {
    const input = document.getElementById('manual-matricula');
    const status = document.getElementById('manual-status');
    const matricula = input.value.trim().toUpperCase();

    if (!claseActiva) return alert("Primero debes iniciar una clase.");
    if (!matricula) return;

    status.innerText = "‚è≥ Registrando...";

    try {
        // 1. Buscar al alumno en el padr√≥n global para obtener su nombre
        const pSnap = await getDoc(doc(db, "padron_alumnos", matricula));
        
        let nombre = "ALUMNO DESCONOCIDO";
        if (pSnap.exists()) {
            nombre = pSnap.data().nombre_oficial;
        }

        // 2. Insertar en la colecci√≥n de asistencias
        await addDoc(collection(db, "asistencias"), {
            id_sesion: claseActiva,
            alumno: { 
                nombre: nombre, 
                matricula: matricula 
            },
            timestamp: serverTimestamp(), // Usa el tiempo del servidor
            tipo: "presente",
            ubicacion: { manual: true }
        });

        status.className = "text-xs mt-1 text-green-600 font-bold italic h-4";
        status.innerText = "‚úÖ Registrado correctamente";
        input.value = ""; // Limpiar campo
        
        // Limpiar mensaje despu√©s de 3 segundos
        setTimeout(() => { status.innerText = ""; }, 3000);

    } catch (e) {
        console.error(e);
        status.className = "text-xs mt-1 text-red-500 font-bold italic h-4";
        status.innerText = "‚ùå Error al registrar";
    }
};
    </script>
</body>
</html>

