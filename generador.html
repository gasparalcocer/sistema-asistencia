<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Docente - UADY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        .tab-active { border-bottom: 3px solid #1e3a8a; color: #1e3a8a; font-weight: 800; background-color: #eff6ff; }
        .tab-inactive { color: #6b7280; hover:bg-gray-50; }
        .table-matrix th, .table-matrix td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; font-size: 0.85rem; }
        .bg-cell-present { background-color: #dcfce7; color: #166534; font-weight: bold; } 
        .bg-cell-absent { background-color: #fee2e2; color: #991b1b; }
        @keyframes highlight {
            0% { background-color: #fef08a; transform: scale(1.02); }
            100% { background-color: white; transform: scale(1); }
        }
        .nuevo-registro { animation: highlight 2s ease-out; }
        /* Estilo para el bot√≥n de eliminar */
        .btn-delete { opacity: 0.6; transition: opacity 0.2s; }
        .registro-item:hover .btn-delete { opacity: 1; }
    </style>
</head>
<body id="main-body" class="bg-gray-100 min-h-screen font-sans" style="display: none;">

    <div id="loader" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-900 mb-4"></div>
        <p class="text-blue-900 font-bold">Cargando Panel Docente...</p>
    </div>

    <nav class="bg-blue-900 text-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="h-8 w-8 bg-white rounded-full flex items-center justify-center text-blue-900 font-bold">U</div>
                <span class="font-bold text-lg">Docente UADY</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="nav-email" class="text-xs text-blue-200 hidden md:block"></span>
                <button id="btn-logout" class="bg-red-600 hover:bg-red-700 text-white text-xs py-2 px-4 rounded font-bold transition">
                    CERRAR SESI√ìN
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4">
        
        <div class="flex flex-wrap border-b border-gray-300 mb-6 bg-white rounded-lg px-2 pt-2 shadow-sm overflow-x-auto">
            <button onclick="cambiarTab('qr')" id="tab-qr" class="tab-active flex-1 py-3 px-4 focus:outline-none transition whitespace-nowrap">
                Generar QR
            </button>
            <button onclick="cambiarTab('historial')" id="tab-historial" class="tab-inactive flex-1 py-3 px-4 focus:outline-none transition whitespace-nowrap">
                Historial Simple
            </button>
            <button onclick="cambiarTab('reporte')" id="tab-reporte" class="tab-inactive flex-1 py-3 px-4 focus:outline-none transition whitespace-nowrap text-blue-700 font-bold">
                üìä S√°bana de Asistencias
            </button>
            <button onclick="cambiarTab('clases')" id="tab-clases" class="tab-inactive flex-1 py-3 px-4 focus:outline-none transition whitespace-nowrap">
                Administrar Clases
            </button>
        </div>

        <div id="view-qr" class="view-section">
            <div class="bg-white p-6 rounded-lg shadow max-w-4xl mx-auto border-t-4 border-blue-900">
                <div id="config-qr-container" class="text-center py-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Pasar Lista</h2>
                    <p class="text-gray-500 mb-6 text-sm">Selecciona una materia para abrir la sesi√≥n.</p>
                    <div class="max-w-md mx-auto">
                        <label class="block text-left text-sm font-bold text-gray-700 mb-1">Materia</label>
                        <select id="select-clase-qr" class="w-full p-3 border rounded bg-gray-50 mb-4 focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Cargar materias... --</option>
                        </select>
                        <button id="btn-iniciar-qr" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition shadow-lg text-lg">
                            INICIAR CLASE
                        </button>
                    </div>
                </div>

                <div id="panel-qr-activo" class="hidden">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <div>
                            <span class="text-xs text-gray-400 font-bold uppercase">Clase en curso</span>
                            <h3 id="titulo-clase-activa" class="text-2xl font-bold text-blue-900 leading-none"></h3>
                        </div>
                        <button onclick="detenerClase()" class="bg-red-100 text-red-700 hover:bg-red-200 px-4 py-2 rounded font-bold text-sm transition">
                            ‚èπ Terminar
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="flex flex-col items-center border-r-0 md:border-r border-gray-200 p-4">
                            <div class="bg-white p-2 inline-block rounded shadow-lg border mb-4">
                                <canvas id="qrcode"></canvas>
                            </div>
                            <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full mb-6">
                                Cambia en: <span id="contador" class="font-bold text-blue-600 w-6 inline-block text-center">10</span>s
                            </div>

                            <div class="w-full bg-yellow-50 border border-yellow-200 rounded-lg p-4 shadow-sm">
                                <h4 class="text-sm font-bold text-yellow-800 mb-2 flex items-center gap-2">
                                    <span>‚úçÔ∏è</span> Registro R√°pido
                                </h4>
                                <p class="text-xs text-yellow-600 mb-3">Escribe la matr√≠cula, el sistema buscar√° el nombre.</p>
                                <div class="space-y-2">
                                    <div class="flex gap-2">
                                        <input type="text" id="manual-matricula" placeholder="Matr√≠cula (Ej: A1234)" class="w-full p-2 text-sm border rounded uppercase focus:ring-2 focus:ring-yellow-500">
                                        <button onclick="registrarManual()" class="bg-yellow-600 text-white px-4 py-2 rounded font-bold hover:bg-yellow-700 transition shadow">
                                            OK
                                        </button>
                                    </div>
                                    <p id="manual-status" class="text-xs text-center text-gray-400 italic h-4"></p>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col h-[500px]">
                            <div class="flex justify-between items-end mb-2">
                                <h4 class="font-bold text-gray-700">Asistentes en Sala</h4>
                                <span id="contador-vivo" class="bg-green-100 text-green-800 text-2xl font-bold px-3 py-1 rounded-lg">0</span>
                            </div>
                            <div class="flex-1 bg-gray-50 rounded-lg border border-gray-200 overflow-hidden flex flex-col">
                                <div class="bg-gray-200 px-4 py-2 text-xs font-bold text-gray-500 flex justify-between">
                                    <span>ALUMNO</span><span>HORA</span>
                                </div>
                                <ul id="lista-asistentes-vivo" class="overflow-y-auto p-2 space-y-2 flex-1">
                                    <li class="text-center text-gray-400 text-sm py-10 italic" id="msg-esperando">Esperando registros...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-historial" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Bit√°cora Diaria</h2>
                    <button onclick="exportarCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold text-sm flex items-center gap-2 shadow transition">
                        <span>üì•</span> Descargar Excel (CSV)
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Materia</label>
                        <select id="filtro-clase" class="w-full p-2 border rounded text-sm"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Fecha</label>
                        <input type="date" id="filtro-fecha" class="w-full p-2 border rounded text-sm">
                    </div>
                    <div class="flex items-end">
                        <button onclick="consultarAsistencias()" class="w-full bg-blue-900 text-white py-2 rounded text-sm font-bold hover:bg-blue-800">Buscar</button>
                    </div>
                </div>
                <div class="overflow-x-auto border rounded">
                    <table class="w-full text-sm text-left text-gray-500" id="tabla-exportable">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-6 py-3">Fecha</th>
                                <th class="px-6 py-3">Hora</th>
                                <th class="px-6 py-3">Alumno</th>
                                <th class="px-6 py-3">Matr√≠cula</th>
                                <th class="px-6 py-3">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <tr><td colspan="5" class="text-center py-4">Selecciona filtros...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-reporte" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4">
                    <div><h2 class="text-xl font-bold text-blue-900">üìä Reporte Global</h2><p class="text-sm text-gray-500">Vista tipo Excel por fechas</p></div>
                    <div class="mt-4 md:mt-0 flex gap-2">
                        <select id="select-clase-reporte" class="p-2 border rounded text-sm min-w-[200px]"><option value="">-- Selecciona Materia --</option></select>
                        <button onclick="generarMatrizAsistencia()" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-green-700 shadow">Generar</button>
                    </div>
                </div>
                <div class="overflow-x-auto bg-white border rounded-lg max-h-[500px]">
                    <table class="w-full table-matrix border-collapse relative">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-xs sticky top-0 z-20 shadow-sm" id="matriz-head"><tr><th class="p-4">Selecciona una materia arriba</th></tr></thead>
                        <tbody class="text-gray-600" id="matriz-body"></tbody>
                    </table>
                </div>
                <p id="msg-reporte" class="text-center text-sm text-gray-400 mt-4"></p>
            </div>
        </div>

        <div id="view-clases" class="view-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow h-fit border-t-4 border-green-600">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">‚ûï Nueva Materia</h2>
                    <form id="form-add-clase">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Nombre</label><input type="text" id="nueva-clase-nombre" required class="w-full p-2 border rounded mb-3">
                        <label class="block text-xs font-bold text-gray-500 mb-1">C√≥digo</label><input type="text" id="nueva-clase-id" class="w-full p-2 border rounded mb-4">
                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Guardar</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">üìö Mis Materias</h2>
                    <ul id="lista-clases" class="space-y-2"><li class="text-gray-400 text-sm italic">Cargando...</li></ul>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth, db, collection, addDoc, serverTimestamp } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, getDocs, query, where, orderBy, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let usuarioActual = null;
        let intervaloQR;
        let qrGenerator;
        let claseActiva = null;
        let unsubscribeLive = null;
        
        // Variable para contar asistentes en tiempo real
        let asistentesVivos = 0;

        window.cambiarTab = (tabName) => {
            if (claseActiva && tabName !== 'qr') {
                if(confirm("Salir detendr√° la sesi√≥n actual. ¬øContinuar?")) detenerClase(); else return;
            }
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => { btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); });
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('tab-active'); activeBtn.classList.remove('tab-inactive');
        };

        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loader');
            const mainBody = document.getElementById('main-body');
            if (user) {
                try {
                    const docSnap = await getDoc(doc(db, "usuarios", user.uid));
                    if (docSnap.exists() && docSnap.data().rol === "profesor") {
                        usuarioActual = user;
                        document.getElementById('nav-email').innerText = user.email;
                        loader.classList.add('hidden');
                        mainBody.style.display = "block";
                        await cargarClases();
                        qrGenerator = new QRious({ element: document.getElementById('qrcode'), size: 250 });
                    } else { alert("Acceso denegado."); window.location.href = "index.html"; }
                } catch (e) { console.error(e); }
            } else { window.location.href = "login.html"; }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "index.html");
        });

        document.getElementById('btn-iniciar-qr').addEventListener('click', () => {
            const nombreClase = document.getElementById('select-clase-qr').value;
            if(!nombreClase) return alert("Selecciona una materia");
            claseActiva = nombreClase;
            document.getElementById('titulo-clase-activa').innerText = nombreClase;
            document.getElementById('config-qr-container').classList.add('hidden');
            document.getElementById('panel-qr-activo').classList.remove('hidden');
            generarQR();
            intervaloQR = setInterval(() => {
                let s = parseInt(document.getElementById('contador').innerText); s--;
                document.getElementById('contador').innerText = s;
                if(s <= 0) { generarQR(); document.getElementById('contador').innerText = 10; }
            }, 1000);
            iniciarMonitorEnVivo(nombreClase);
        });

        window.detenerClase = () => {
            clearInterval(intervaloQR);
            if (unsubscribeLive) { unsubscribeLive(); unsubscribeLive = null; }
            document.getElementById('panel-qr-activo').classList.add('hidden');
            document.getElementById('config-qr-container').classList.remove('hidden');
            claseActiva = null;
            document.getElementById('lista-asistentes-vivo').innerHTML = '<li class="text-center text-gray-400 text-sm py-10 italic">Esperando registros...</li>';
            asistentesVivos = 0;
            document.getElementById('contador-vivo').innerText = "0";
            document.getElementById('manual-matricula').value = "";
            document.getElementById('manual-status').innerText = "";
        };

        window.registrarManual = async () => {
            const mat = document.getElementById('manual-matricula').value.toUpperCase().trim();
            const statusEl = document.getElementById('manual-status');
            
            if(!mat) return;
            statusEl.innerText = "Buscando alumno...";
            
            try {
                const q = query(collection(db, "usuarios"), where("matricula", "==", mat));
                const querySnapshot = await getDocs(q);
                let nombreFinal = "ALUMNO EXTERNO"; 
                if (!querySnapshot.empty) { nombreFinal = querySnapshot.docs[0].data().nombre; }

                await addDoc(collection(db, "asistencias"), {
                    id_sesion: claseActiva,
                    qr_token: new Date().getTime(),
                    alumno: { nombre: nombreFinal, matricula: mat },
                    ubicacion: { lat: 0, lng: 0, manual: true },
                    timestamp: serverTimestamp(),
                    dispositivo: "Registro Manual Docente"
                });
                document.getElementById('manual-matricula').value = "";
                statusEl.innerText = `‚úì Registrado: ${nombreFinal}`;
                setTimeout(() => statusEl.innerText = "", 3000);
            } catch (e) {
                statusEl.innerText = "Error: " + e.message;
                if(e.message.includes("index")) alert("Falta √≠ndice en 'usuarios'. Revisa consola.");
            }
        };

        // --- NUEVA FUNCI√ìN PARA ELIMINAR DEL VIVO ---
        window.eliminarRegistroVivo = async (idAsistencia) => {
            if(confirm("¬øEliminar este registro de asistencia?")) {
                try {
                    await deleteDoc(doc(db, "asistencias", idAsistencia));
                    // El onSnapshot se encargar√° de actualizar la vista autom√°ticamente
                } catch (e) {
                    alert("Error eliminando: " + e.message);
                }
            }
        };

        function iniciarMonitorEnVivo(materia) {
            const listaEl = document.getElementById('lista-asistentes-vivo');
            const contadorEl = document.getElementById('contador-vivo');
            const horaInicio = new Date();
            const q = query(collection(db, "asistencias"), where("id_sesion", "==", materia), where("timestamp", ">=", horaInicio), orderBy("timestamp", "desc"));
            
            unsubscribeLive = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const docId = change.doc.id;

                    // CASO 1: NUEVO REGISTRO
                    if (change.type === "added") {
                        const msgEsperando = document.getElementById('msg-esperando');
                        if(msgEsperando) msgEsperando.remove();
                        
                        asistentesVivos++;
                        contadorEl.innerText = asistentesVivos;
                        
                        const hora = data.timestamp ? data.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}) : "Reciente";
                        const esManual = data.ubicacion && data.ubicacion.manual;
                        const icon = esManual ? "‚úçÔ∏è" : "üì±";
                        const estilo = esManual ? "border-yellow-400 bg-yellow-50" : "border-green-500 bg-white";
                        
                        // A√±adimos ID al LI para poder borrarlo luego si hace falta
                        const li = document.createElement('li');
                        li.id = `asistencia-${docId}`;
                        li.className = `registro-item flex justify-between items-center p-3 rounded shadow-sm border-l-4 nuevo-registro ${estilo} group`;
                        li.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div>
                                    <p class="font-bold text-gray-800 text-sm uppercase">${icon} ${data.alumno.nombre}</p>
                                    <p class="text-xs text-gray-500">${data.alumno.matricula}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-mono text-gray-400 font-bold">${hora}</span>
                                <button onclick="eliminarRegistroVivo('${docId}')" class="btn-delete text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50" title="Eliminar Asistencia">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `;
                        listaEl.prepend(li);
                    }
                    
                    // CASO 2: ELIMINADO (Esto pasa cuando borras con el bot√≥n üóëÔ∏è)
                    if (change.type === "removed") {
                        const liToRemove = document.getElementById(`asistencia-${docId}`);
                        if (liToRemove) {
                            liToRemove.remove();
                            asistentesVivos--;
                            contadorEl.innerText = asistentesVivos;
                        }
                    }
                });
            }, (error) => { if(error.message.includes("index")) alert("‚ö†Ô∏è Revisa la consola para crear el √≠ndice."); });
        }

        function generarQR() {
            if(!claseActiva) return;
            const data = JSON.stringify({ id: claseActiva, t: new Date().getTime(), s: Math.random().toString(36).substring(7) });
            qrGenerator.value = data;
        }

        async function cargarClases() {
            const listaUl = document.getElementById('lista-clases');
            const selects = [document.getElementById('select-clase-qr'), document.getElementById('filtro-clase'), document.getElementById('select-clase-reporte')];
            listaUl.innerHTML = ""; selects.forEach(s => s.innerHTML = '<option value="">-- Selecciona Materia --</option>');
            try {
                const q = query(collection(db, "clases"), where("profesor_uid", "==", usuarioActual.uid));
                const snap = await getDocs(q);
                if(snap.empty) listaUl.innerHTML = '<li class="text-gray-500 text-sm">Sin materias.</li>';
                snap.forEach(d => {
                    const data = d.data();
                    const li = document.createElement('li');
                    li.className = "flex justify-between bg-gray-50 p-3 rounded border";
                    li.innerHTML = `<div><p class="font-bold text-gray-800 text-sm">${data.nombre}</p><p class="text-xs text-gray-500">${data.codigo||''}</p></div><button onclick="eliminarClase('${d.id}')" class="text-red-500 text-xs font-bold border p-1 rounded">Eliminar</button>`;
                    listaUl.appendChild(li);
                    selects.forEach(s => s.add(new Option(data.nombre, data.nombre)));
                });
            } catch (e) { console.error(e); }
        }

        document.getElementById('form-add-clase').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('nueva-clase-nombre').value;
            const codigo = document.getElementById('nueva-clase-id').value;
            try {
                await addDoc(collection(db, "clases"), { nombre, codigo, profesor_uid: usuarioActual.uid, creado: serverTimestamp() });
                document.getElementById('nueva-clase-nombre').value=""; document.getElementById('nueva-clase-id').value="";
                alert("Materia guardada."); cargarClases();
            } catch (e) { alert("Error: "+e.message); }
        });

        window.eliminarClase = async (id) => { if(confirm("¬øEliminar?")) { await deleteDoc(doc(db, "clases", id)); cargarClases(); } };

        window.consultarAsistencias = async () => {
            const filtroClase = document.getElementById('filtro-clase').value;
            const filtroFecha = document.getElementById('filtro-fecha').value;
            const tbody = document.getElementById('tabla-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-blue-500">Buscando...</td></tr>';
            try {
                let q = query(collection(db, "asistencias"), orderBy("timestamp", "desc"));
                if (filtroClase) q = query(collection(db, "asistencias"), where("id_sesion", "==", filtroClase), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                tbody.innerHTML = ""; let count=0;
                snap.forEach(doc => {
                    const data = doc.data();
                    const fechaObj = data.timestamp.toDate();
                    let fechaFiltro = fechaObj.toISOString().split('T')[0];
                    if (!filtroFecha || filtroFecha === fechaFiltro) {
                        count++;
                        tbody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4">${fechaObj.toLocaleDateString()}</td><td class="px-6 py-4 font-mono text-xs">${fechaObj.toLocaleTimeString()}</td><td class="px-6 py-4 font-bold text-gray-700">${data.alumno.nombre}</td><td class="px-6 py-4">${data.alumno.matricula}</td><td class="px-6 py-4"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">Presente</span></td></tr>`;
                    }
                });
                if(count===0) tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No hay datos.</td></tr>';
            } catch (e) { console.error(e); tbody.innerHTML=`<tr><td colspan="5" class="text-center text-red-500">Error: ${e.message}</td></tr>`; }
        };

        window.exportarCSV = () => {
            const rows = document.querySelectorAll('#tabla-body tr');
            if (rows.length === 0 || rows[0].innerText.includes('No hay datos')) return alert("No hay datos para exportar.");
            let csvContent = "\uFEFFFecha,Hora,Alumno,Matricula,Estado\n";
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length > 1) { const rowData = Array.from(cols).map(col => `"${col.innerText}"`).join(","); csvContent += rowData + "\n"; }
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Reporte_${new Date().toISOString().split('T')[0]}.csv`; link.click();
        };

        window.generarMatrizAsistencia = async () => {
            const materia = document.getElementById('select-clase-reporte').value;
            const thead = document.getElementById('matriz-head'); const tbody = document.getElementById('matriz-body'); const msg = document.getElementById('msg-reporte');
            if(!materia) return alert("Selecciona materia");
            tbody.innerHTML = '<tr><td colspan="10" class="text-center p-4">Procesando...</td></tr>';
            try {
                const q = query(collection(db, "asistencias"), where("id_sesion", "==", materia));
                const snap = await getDocs(q);
                if(snap.empty) { tbody.innerHTML='<tr><td colspan="10" class="text-center p-4">Sin registros.</td></tr>'; return; }
                const fechasSet = new Set(); const alumnosMap = {};
                snap.forEach(doc => {
                    const d = doc.data(); const f = d.timestamp.toDate().toISOString().split('T')[0]; fechasSet.add(f);
                    if(!alumnosMap[d.alumno.matricula]) alumnosMap[d.alumno.matricula] = { nombre: d.alumno.nombre, asistencias: new Set() };
                    alumnosMap[d.alumno.matricula].asistencias.add(f);
                });
                const fechas = Array.from(fechasSet).sort();
                let head = `<tr><th class="bg-gray-200 sticky left-0 z-10 w-64 text-left p-2">ALUMNO</th><th class="bg-blue-100 text-blue-800 p-2">%</th>`;
                fechas.forEach(f => { const p=f.split('-'); head+=`<th class="bg-gray-100 min-w-[50px] p-2">${p[2]}/${p[1]}</th>`; });
                thead.innerHTML = head + '</tr>'; tbody.innerHTML = "";
                Object.keys(alumnosMap).sort((a,b)=>alumnosMap[a].nombre.localeCompare(alumnosMap[b].nombre)).forEach(mat => {
                    const al = alumnosMap[mat]; const porc = Math.round((al.asistencias.size/fechas.length)*100);
                    let color = porc<80 ? "text-red-600 font-bold" : (porc===100?"text-green-600 font-bold":"text-gray-700");
                    let row = `<tr class="hover:bg-gray-50 transition"><td class="sticky left-0 bg-white border-r text-left font-bold text-gray-700 px-3 py-2 text-xs md:text-sm whitespace-nowrap">${al.nombre}</td><td class="${color} border-r bg-blue-50">${porc}%</td>`;
                    fechas.forEach(f => row+=`<td class="${al.asistencias.has(f)?'bg-cell-present':'bg-cell-absent'}">${al.asistencias.has(f)?'1':'0'}</td>`);
                    tbody.innerHTML += row + '</tr>';
                });
                msg.innerText = `Total: ${Object.keys(alumnosMap).length} alumnos, ${fechas.length} sesiones.`;
            } catch (e) { console.error(e); tbody.innerHTML=`<tr><td colspan="10" class="text-center text-red-500 p-4">Error: ${e.message}</td></tr>`; }
        };
    </script>
</body>
</html>
