<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Docente - UADY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        .tab-active { border-bottom: 2px solid #1e3a8a; color: #1e3a8a; font-weight: bold; }
        .tab-inactive { color: #6b7280; }
    </style>
</head>
<body id="main-body" class="bg-gray-100 min-h-screen font-sans" style="display: none;">

    <div id="loader" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-900 mb-4"></div>
        <p class="text-blue-900 font-bold">Cargando Panel Docente...</p>
    </div>

    <nav class="bg-blue-900 text-white shadow-md">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="h-8 w-8 bg-white rounded-full flex items-center justify-center text-blue-900 font-bold">U</div>
                <span class="font-bold text-lg">Docente UADY</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="nav-email" class="text-xs text-blue-200 hidden md:block"></span>
                <button id="btn-logout" class="bg-red-600 hover:bg-red-700 text-white text-xs py-2 px-4 rounded font-bold transition">
                    CERRAR SESI√ìN
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4">
        
        <div class="flex border-b border-gray-300 mb-6 bg-white rounded-t-lg px-4 pt-2 shadow-sm">
            <button onclick="cambiarTab('qr')" id="tab-qr" class="tab-active py-3 px-6 focus:outline-none">
                Generar QR
            </button>
            <button onclick="cambiarTab('historial')" id="tab-historial" class="tab-inactive py-3 px-6 focus:outline-none">
                Historial de Asistencia
            </button>
            <button onclick="cambiarTab('clases')" id="tab-clases" class="tab-inactive py-3 px-6 focus:outline-none">
                Administrar Clases
            </button>
        </div>

        <div id="view-qr" class="view-section">
            <div class="bg-white p-8 rounded-lg shadow text-center max-w-lg mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Pasar Lista</h2>
                <p class="text-gray-500 mb-6 text-sm">Selecciona una clase para generar el c√≥digo.</p>

                <div id="selector-clase-container">
                    <label class="block text-left text-sm font-bold text-gray-700 mb-1">Seleccionar Materia</label>
                    <select id="select-clase-qr" class="w-full p-3 border rounded bg-gray-50 mb-4 focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Cargar materias... --</option>
                    </select>
                    
                    <button id="btn-iniciar-qr" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition">
                        Comenzar Clase
                    </button>
                </div>

                <div id="panel-qr-activo" class="hidden mt-6 border-t pt-6">
                    <h3 id="titulo-clase-activa" class="text-xl font-bold text-blue-900 mb-2"></h3>
                    <div class="flex justify-center mb-4 bg-white p-2 inline-block rounded">
                        <canvas id="qrcode"></canvas>
                    </div>
                    <div class="text-sm text-gray-500">
                        Actualizando seguridad en: <span id="contador" class="font-bold text-red-500 text-xl">10</span>s
                    </div>
                    <button onclick="detenerClase()" class="mt-6 text-red-500 underline text-sm hover:text-red-700">
                        Detener Clase
                    </button>
                </div>
            </div>
        </div>

        <div id="view-historial" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Reporte de Asistencias</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Materia</label>
                        <select id="filtro-clase" class="w-full p-2 border rounded text-sm">
                            <option value="todas">Todas las materias</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Fecha</label>
                        <input type="date" id="filtro-fecha" class="w-full p-2 border rounded text-sm">
                    </div>
                    <div class="flex items-end">
                        <button onclick="consultarAsistencias()" class="w-full bg-blue-900 text-white py-2 rounded text-sm font-bold hover:bg-blue-800">
                            Buscar üîç
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3">Fecha/Hora</th>
                                <th class="px-6 py-3">Alumno</th>
                                <th class="px-6 py-3">Matr√≠cula</th>
                                <th class="px-6 py-3">Materia</th>
                                <th class="px-6 py-3">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <tr><td colspan="5" class="text-center py-4">Selecciona filtros y busca para ver resultados</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-clases" class="view-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="bg-white p-6 rounded-lg shadow h-fit">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">‚ûï Nueva Materia</h2>
                    <form id="form-add-clase">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Nombre de la materia</label>
                        <input type="text" id="nueva-clase-nombre" required placeholder="Ej: C√°lculo Diferencial" class="w-full p-2 border rounded mb-3">
                        
                        <label class="block text-xs font-bold text-gray-500 mb-1">C√≥digo / ID (Opcional)</label>
                        <input type="text" id="nueva-clase-id" placeholder="Ej: MAT-101" class="w-full p-2 border rounded mb-4">

                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">
                            Guardar Materia
                        </button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">üìö Mis Materias</h2>
                    <ul id="lista-clases" class="space-y-2">
                        <li class="text-gray-400 text-sm italic">Cargando...</li>
                    </ul>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { auth, db, collection, addDoc, serverTimestamp } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, getDocs, query, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- VARIABLES GLOBALES ---
        let usuarioActual = null;
        let listaMisClases = [];
        let intervaloQR;
        let qrGenerator;
        let claseActiva = null;

        // --- INICIALIZACI√ìN ---
        window.cambiarTab = (tabName) => {
            // Ocultar todas
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            
            // Actualizar estilos botones
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-${tabName}`).classList.remove('tab-inactive');
        };

        // --- SEGURIDAD Y CARGA INICIAL ---
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loader');
            const mainBody = document.getElementById('main-body');

            if (user) {
                try {
                    const docSnap = await getDoc(doc(db, "usuarios", user.uid));
                    if (docSnap.exists() && docSnap.data().rol === "profesor") {
                        usuarioActual = user;
                        document.getElementById('nav-email').innerText = user.email;
                        loader.classList.add('hidden');
                        mainBody.style.display = "block";
                        
                        // Cargar datos iniciales
                        await cargarClases();

                    } else {
                        alert("‚õî Acceso exclusivo para docentes.");
                        window.location.href = "index.html";
                    }
                } catch (e) {
                    console.error(e);
                    window.location.href = "index.html";
                }
            } else {
                window.location.href = "login.html";
            }
        });

        // --- LOGOUT ---
        document.getElementById('btn-logout').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "index.html");
        });

        // ==========================================
        //  M√ìDULO 1: ADMINISTRAR CLASES
        // ==========================================
        
        // 1. Cargar clases de Firestore
        async function cargarClases() {
            const listaUl = document.getElementById('lista-clases');
            const selectQr = document.getElementById('select-clase-qr');
            const selectFiltro = document.getElementById('filtro-clase');
            
            listaUl.innerHTML = "";
            selectQr.innerHTML = '<option value="">-- Selecciona una materia --</option>';
            selectFiltro.innerHTML = '<option value="todas">Todas las materias</option>';

            try {
                // Buscamos clases creadas por este profesor (usando su UID)
                const q = query(collection(db, "clases"), where("profesor_uid", "==", usuarioActual.uid));
                const querySnapshot = await getDocs(q);
                
                listaMisClases = [];
                
                if(querySnapshot.empty) {
                    listaUl.innerHTML = '<li class="text-gray-500 text-sm">A√∫n no has agregado materias.</li>';
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const claseObj = { id: doc.id, ...data };
                    listaMisClases.push(claseObj);

                    // A) Agregar a la lista visual
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-gray-50 p-3 rounded border";
                    li.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800">${data.nombre}</p>
                            <p class="text-xs text-gray-500">${data.codigo || 'Sin c√≥digo'}</p>
                        </div>
                        <button onclick="eliminarClase('${doc.id}')" class="text-red-500 hover:text-red-700 text-xs font-bold">üóëÔ∏è</button>
                    `;
                    listaUl.appendChild(li);

                    // B) Agregar a los Selects (Dropdowns)
                    const option1 = new Option(data.nombre, data.nombre); // Guardamos el Nombre como valor para el QR
                    selectQr.add(option1);

                    const option2 = new Option(data.nombre, data.nombre);
                    selectFiltro.add(option2);
                });

            } catch (e) {
                console.error("Error cargando clases:", e);
            }
        }

        // 2. Crear nueva clase
        document.getElementById('form-add-clase').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('nueva-clase-nombre').value;
            const codigo = document.getElementById('nueva-clase-id').value;
            const btn = e.target.querySelector('button');

            try {
                btn.innerText = "Guardando...";
                btn.disabled = true;

                await addDoc(collection(db, "clases"), {
                    nombre: nombre,
                    codigo: codigo,
                    profesor_uid: usuarioActual.uid,
                    creado: serverTimestamp()
                });

                // Reset y recargar
                document.getElementById('nueva-clase-nombre').value = "";
                document.getElementById('nueva-clase-id').value = "";
                alert("Materia agregada correctamente.");
                await cargarClases();

            } catch (error) {
                alert("Error al guardar: " + error.message);
            } finally {
                btn.innerText = "Guardar Materia";
                btn.disabled = false;
            }
        });

        // 3. Eliminar clase (Funci√≥n global para el onclick del HTML)
        window.eliminarClase = async (id) => {
            if(confirm("¬øSeguro que deseas eliminar esta materia?")) {
                await deleteDoc(doc(db, "clases", id));
                cargarClases();
            }
        };


        // ==========================================
        //  M√ìDULO 2: GENERADOR QR
        // ==========================================
        
        qrGenerator = new QRious({
            element: document.getElementById('qrcode'),
            size: 250,
            value: '' 
        });

        document.getElementById('btn-iniciar-qr').addEventListener('click', () => {
            const nombreClase = document.getElementById('select-clase-qr').value;
            if(!nombreClase) return alert("Por favor, selecciona una materia primero.");

            claseActiva = nombreClase;
            document.getElementById('titulo-clase-activa').innerText = nombreClase;
            
            // UI Toggle
            document.getElementById('selector-clase-container').classList.add('hidden');
            document.getElementById('panel-qr-activo').classList.remove('hidden');

            generarQR();
            intervaloQR = setInterval(actualizarCiclo, 1000);
        });

        window.detenerClase = () => {
            clearInterval(intervaloQR);
            document.getElementById('panel-qr-activo').classList.add('hidden');
            document.getElementById('selector-clase-container').classList.remove('hidden');
            claseActiva = null;
        };

        let segundos = 10;
        function actualizarCiclo() {
            segundos--;
            document.getElementById('contador').innerText = segundos;
            if (segundos <= 0) {
                generarQR();
                segundos = 10;
            }
        }

        function generarQR() {
            if(!claseActiva) return;
            const data = JSON.stringify({
                id: claseActiva, // Enviamos el nombre de la materia como ID
                t: new Date().getTime(),
                s: Math.random().toString(36).substring(7)
            });
            qrGenerator.value = data;
        }


        // ==========================================
        //  M√ìDULO 3: HISTORIAL (CONSULTAS)
        // ==========================================
        
        window.consultarAsistencias = async () => {
            const filtroClase = document.getElementById('filtro-clase').value;
            const filtroFecha = document.getElementById('filtro-fecha').value; // Formato YYYY-MM-DD
            const tbody = document.getElementById('tabla-body');

            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-blue-500 font-bold">Buscando...</td></tr>';

            try {
                // Consulta base
                // Nota: Firestore tiene limitaciones con filtros m√∫ltiples sin √≠ndices compuestos.
                // Para simplificar, traeremos las √∫ltimas asistencias y filtraremos en JS si es necesario,
                // o usaremos un filtro simple.
                
                let q = query(collection(db, "asistencias"), orderBy("timestamp", "desc"));
                
                if (filtroClase !== "todas") {
                    q = query(collection(db, "asistencias"), where("id_sesion", "==", filtroClase), orderBy("timestamp", "desc"));
                }
                // (Nota: Si te sale error de √≠ndice en consola, Firebase te dar√° un link para crearlo autom√°ticamente).

                const snapshot = await getDocs(q);
                
                tbody.innerHTML = "";
                let count = 0;

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No se encontraron registros.</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Filtrado de FECHA manual (JavaScript) porque Firestore no permite buscar por substring de fecha f√°cil
                    let mostrar = true;
                    let fechaStr = "---";
                    
                    if (data.timestamp) {
                        const dateObj = data.timestamp.toDate();
                        fechaStr = dateObj.toLocaleString();
                        
                        if (filtroFecha) {
                            // Comparar YYYY-MM-DD
                            const fechaRegistro = dateObj.toISOString().split('T')[0];
                            if (fechaRegistro !== filtroFecha) mostrar = false;
                        }
                    }

                    if (mostrar) {
                        count++;
                        const row = `
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td class="px-6 py-4">${fechaStr}</td>
                                <td class="px-6 py-4 font-medium text-gray-900">${data.alumno.nombre || 'Anon'}</td>
                                <td class="px-6 py-4">${data.alumno.matricula || '---'}</td>
                                <td class="px-6 py-4 text-blue-600">${data.id_sesion}</td>
                                <td class="px-6 py-4"><span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">Presente</span></td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    }
                });

                if(count === 0) {
                     tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No hay asistencias en esa fecha.</td></tr>';
                }

            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Error (Revisa consola): ${error.message}</td></tr>`;
            }
        };

    </script>
</body>
</html>
