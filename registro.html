<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Sistema UADY</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
        <h1 class="text-2xl font-bold text-center text-blue-900 mb-6">Crear Cuenta Nueva</h1>

        <div class="flex mb-6 border-b">
            <button id="tab-alumno" class="flex-1 py-2 text-blue-600 border-b-2 border-blue-600 font-bold focus:outline-none transition">Soy Alumno</button>
            <button id="tab-profesor" class="flex-1 py-2 text-gray-500 hover:text-blue-600 focus:outline-none transition">Soy Profesor</button>
        </div>

        <form id="registro-form" class="space-y-4">
            
            <div id="campo-nombre" class="hidden">
                <label class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                <input type="text" id="nombre" class="w-full p-2 border rounded bg-gray-50 uppercase" placeholder="JUAN P칄REZ">
            </div>

            <div id="campo-matricula">
                <label class="block text-sm font-medium text-gray-700">Matr칤cula (Solo n칰meros)</label>
                <input type="text" id="matricula" inputmode="numeric" pattern="[0-9]*" class="w-full p-2 border rounded bg-gray-50" placeholder="18001234">
                <p class="text-[10px] text-gray-400 mt-1">Ingresa los 8 d칤gitos de tu matr칤cula sin letras.</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Correo Institucional</label>
                <input type="email" id="email" required class="w-full p-2 border rounded bg-gray-50" placeholder="usuario@correo.uady.mx">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Contrase침a (M칤n. 6 caracteres)</label>
                <input type="password" id="password" required class="w-full p-2 border rounded bg-gray-50" placeholder="******">
            </div>

            <div id="campo-secreto" class="hidden bg-yellow-50 p-3 rounded border border-yellow-200">
                <label class="block text-sm font-bold text-yellow-800">游 Clave de Autenticaci칩n Docente</label>
                <input type="password" id="clave-profe" class="w-full p-2 border rounded mt-1" placeholder="Solo personal autorizado">
            </div>

            <div id="error-msg" class="text-red-500 text-sm text-center hidden font-bold"></div>

            <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition shadow-lg">
                Registrarme como Alumno
            </button>
        </form>

        <p class="text-center mt-4 text-sm text-gray-600">
            쯏a tienes cuenta? <a href="login.html" class="text-blue-600 font-bold hover:underline">Inicia Sesi칩n aqu칤</a>
        </p>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // Importaciones a침adidas: collection, query, where, getDocs
        import { doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let esProfesor = false;
        const CLAVE_MAESTRA = "Profe-UADY-asist26"; 

        const tabAlumno = document.getElementById('tab-alumno');
        const tabProfesor = document.getElementById('tab-profesor');
        const campoNombre = document.getElementById('campo-nombre');
        const campoMatricula = document.getElementById('campo-matricula');
        const campoSecreto = document.getElementById('campo-secreto');
        const btnSubmit = document.getElementById('btn-submit');
        const errorMsg = document.getElementById('error-msg');
        const form = document.getElementById('registro-form');

        // L칩gica de Pesta침as
        tabAlumno.addEventListener('click', (e) => { e.preventDefault(); activarModo(false); });
        tabProfesor.addEventListener('click', (e) => { e.preventDefault(); activarModo(true); });

        function activarModo(modoProfe) {
            esProfesor = modoProfe;
            errorMsg.classList.add('hidden');
            
            if (esProfesor) {
                tabProfesor.className = "flex-1 py-2 text-blue-600 border-b-2 border-blue-600 font-bold focus:outline-none transition";
                tabAlumno.className = "flex-1 py-2 text-gray-500 hover:text-blue-600 focus:outline-none transition";
                campoNombre.classList.remove('hidden');
                campoMatricula.classList.add('hidden');
                campoSecreto.classList.remove('hidden');
                btnSubmit.innerText = "Registrarme como Profesor";
                btnSubmit.className = "w-full bg-orange-600 text-white py-3 rounded font-bold hover:bg-orange-700 transition shadow-lg";
            } else {
                tabAlumno.className = "flex-1 py-2 text-blue-600 border-b-2 border-blue-600 font-bold focus:outline-none transition";
                tabProfesor.className = "flex-1 py-2 text-gray-500 hover:text-blue-600 focus:outline-none transition";
                campoNombre.classList.add('hidden');
                campoMatricula.classList.remove('hidden');
                campoSecreto.classList.add('hidden');
                btnSubmit.innerText = "Registrarme como Alumno";
                btnSubmit.className = "w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition shadow-lg";
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.classList.add('hidden');

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const matriculaRaw = document.getElementById('matricula').value.trim();
            const nombreIngresado = document.getElementById('nombre').value.toUpperCase().trim();
            const claveIngresada = document.getElementById('clave-profe').value;

            // --- NORMALIZACI칍N DE MATR칈CULA ---
            // Eliminamos cualquier letra (como la 'A') y dejamos solo n칰meros
            const matricula = matriculaRaw.replace(/\D/g, ""); 

            try {
                btnSubmit.disabled = true;
                btnSubmit.innerText = "Verificando...";

                let nombreFinal = nombreIngresado;

                // --- VALIDACI칍N DE PADR칍N PARA ALUMNOS ---
                if (!esProfesor) {
                    if (!matricula) {
                        throw new Error("Por favor ingresa tu matr칤cula.");
                    }

                    // Buscamos en la colecci칩n 'padron_alumnos' donde el campo 'matricula' coincida
                    const q = query(collection(db, "padron_alumnos"), where("matricula", "==", matricula));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        btnSubmit.disabled = false;
                        btnSubmit.innerText = "Registrarme como Alumno";
                        return mostrarError(`游뛂 Matr칤cula ${matricula} no encontrada en el padr칩n oficial.`);
                    }
                    
                    // Extraemos los datos del alumno encontrado
                    const datosAlumno = querySnapshot.docs[0].data();
                    nombreFinal = datosAlumno.nombre_oficial;
                } else {
                    // Validaci칩n de Profesor
                    if (claveIngresada !== CLAVE_MAESTRA) {
                        btnSubmit.disabled = false;
                        btnSubmit.innerText = "Registrarme como Profesor";
                        return mostrarError("Clave docente incorrecta.");
                    }
                    if (!nombreFinal) {
                        btnSubmit.disabled = false;
                        btnSubmit.innerText = "Registrarme como Profesor";
                        return mostrarError("Por favor, ingresa tu nombre.");
                    }
                }

                // --- CREACI칍N DE CUENTA EN AUTH ---
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // --- GUARDADO EN FIRESTORE (USUARIOS ACTIVOS) ---
                await setDoc(doc(db, "usuarios", user.uid), {
                    email: email,
                    nombre: nombreFinal,
                    rol: esProfesor ? "profesor" : "alumno",
                    matricula: esProfesor ? "N/A" : matricula,
                    fecha_registro: new Date()
                });

                alert("춰Bienvenido, " + nombreFinal + "!");
                window.location.href = esProfesor ? "generador.html" : "escaner.html";

            } catch (error) {
                console.error(error);
                let msg = "Error: " + error.message;
                if (error.code === 'auth/email-already-in-use') msg = "Este correo ya est치 registrado.";
                if (error.code === 'auth/weak-password') msg = "La contrase침a debe tener al menos 6 caracteres.";
                
                mostrarError(msg);
                btnSubmit.disabled = false;
                btnSubmit.innerText = esProfesor ? "Registrarme como Profesor" : "Registrarme como Alumno";
            }
        });

        function mostrarError(msg) {
            errorMsg.innerHTML = msg;
            errorMsg.classList.remove('hidden');
        }
    </script>
</body>
</html>
