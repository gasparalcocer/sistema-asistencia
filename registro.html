<form id="registro-form" class="space-y-4">
            
            <div id="campo-nombre" class="hidden">
                <label class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                <input type="text" id="nombre" class="w-full p-2 border rounded bg-gray-50 uppercase" placeholder="JUAN P칄REZ">
            </div>

            <div id="campo-matricula">
                <label class="block text-sm font-medium text-gray-700">Matr칤cula (Solo n칰meros)</label>
                <input type="text" id="matricula" required 
                       inputmode="numeric" pattern="[0-9]*"
                       class="w-full p-2 border rounded bg-gray-50" placeholder="18001234">
                <p class="text-[10px] text-gray-400 mt-1">Ingresa 칰nicamente los 8 d칤gitos de tu matr칤cula.</p>
            </div>

            <div id="error-msg" class="text-red-500 text-sm text-center hidden font-bold"></div>

            <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition shadow-lg">
                Registrarme como Alumno
            </button>
        </form>
<script type="module">
        // 1. IMPORTACIONES ACTUALIZADAS: Agregamos query, collection, where y getDocs
        import { auth, db } from './firebase-config.js';
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ... (l칩gica de pesta침as y activarModo se mantiene igual) ...

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.classList.add('hidden');

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            let matriculaRaw = document.getElementById('matricula').value.trim();
            const nombreIngresado = document.getElementById('nombre').value.toUpperCase().trim();
            const claveIngresada = document.getElementById('clave-profe').value;

            // 2. FORZAR FORMATO NUM칄RICO: Eliminamos cualquier 'A' o letra que el usuario pegue
            let matricula = matriculaRaw.replace(/\D/g, ""); 

            try {
                btnSubmit.disabled = true;
                btnSubmit.innerText = "Verificando...";

                let nombreFinal = nombreIngresado;

                // --- VALIDACI칍N DE PADR칍N PARA ALUMNOS ---
                if (!esProfesor) {
                    if (matricula === "") return mostrarError("Ingresa una matr칤cula v치lida.");

                    // 3. CAMBIO CR칈TICO: Buscamos por campo 'matricula' en lugar de ID de documento
                    const q = query(collection(db, "padron_alumnos"), where("matricula", "==", matricula));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        btnSubmit.disabled = false;
                        btnSubmit.innerText = "Registrarme como Alumno";
                        return mostrarError(`游뛂 La matr칤cula ${matricula} no est치 en el padr칩n oficial.`);
                    }

                    // Recuperar el nombre del primer documento encontrado
                    const datosAlumno = querySnapshot.docs[0].data();
                    nombreFinal = datosAlumno.nombre_oficial;
                } else {
                    // Validaci칩n de Profesor (sin cambios)
                    if (claveIngresada !== CLAVE_MAESTRA) {
                        btnSubmit.disabled = false;
                        btnSubmit.innerText = "Registrarme como Profesor";
                        return mostrarError("Clave docente incorrecta.");
                    }
                    if (!nombreFinal) {
                        btnSubmit.disabled = false;
                        btnSubmit.innerText = "Registrarme como Profesor";
                        return mostrarError("Por favor, ingresa tu nombre.");
                    }
                }

                // --- CREACI칍N DE CUENTA ---
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, "usuarios", user.uid), {
                    email: email,
                    nombre: nombreFinal,
                    rol: esProfesor ? "profesor" : "alumno",
                    matricula: esProfesor ? "N/A" : matricula,
                    fecha_registro: new Date()
                });

                alert("춰Bienvenido, " + nombreFinal + "!");
                window.location.href = esProfesor ? "generador.html" : "escaner.html";

            } catch (error) {
                console.error(error);
                let msg = "Error: " + error.code;
                if (error.code === 'auth/email-already-in-use') msg = "Este correo ya est치 registrado.";
                mostrarError(msg);
                btnSubmit.disabled = false;
                btnSubmit.innerText = esProfesor ? "Registrarme como Profesor" : "Registrarme como Alumno";
            }
        });

        function mostrarError(msg) {
            errorMsg.innerHTML = msg;
            errorMsg.classList.remove('hidden');
        }
    </script>
