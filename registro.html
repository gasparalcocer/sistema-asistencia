<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Sistema UADY</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
        <h1 class="text-2xl font-bold text-center text-blue-900 mb-6">Crear Cuenta Nueva</h1>

        <div class="flex mb-6 border-b">
            <button id="tab-alumno" class="flex-1 py-2 text-blue-600 border-b-2 border-blue-600 font-bold focus:outline-none">Soy Alumno</button>
            <button id="tab-profesor" class="flex-1 py-2 text-gray-500 hover:text-blue-600 focus:outline-none">Soy Profesor</button>
        </div>

        <form id="registro-form" class="space-y-4">
            
            <div>
                <label class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                <input type="text" id="nombre" required class="w-full p-2 border rounded bg-gray-50 uppercase" placeholder="JUAN P칄REZ">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Correo Institucional</label>
                <input type="email" id="email" required class="w-full p-2 border rounded bg-gray-50" placeholder="usuario@uady.mx">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Contrase침a (M칤n. 6 caracteres)</label>
                <input type="password" id="password" required class="w-full p-2 border rounded bg-gray-50" placeholder="******">
            </div>

            <div id="campo-matricula">
                <label class="block text-sm font-medium text-gray-700">Matr칤cula</label>
                <input type="text" id="matricula" class="w-full p-2 border rounded bg-gray-50 uppercase" placeholder="A12345678">
            </div>

            <div id="campo-secreto" class="hidden bg-yellow-50 p-3 rounded border border-yellow-200">
                <label class="block text-sm font-bold text-yellow-800">游 Clave de Autenticaci칩n Docente</label>
                <input type="password" id="clave-profe" class="w-full p-2 border rounded mt-1" placeholder="Solo personal autorizado">
                <p class="text-xs text-gray-500 mt-1">Escribe: PROFE123</p>
            </div>

            <div id="error-msg" class="text-red-500 text-sm text-center hidden font-bold"></div>

            <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition">
                Registrarme como Alumno
            </button>
        </form>

        <p class="text-center mt-4 text-sm text-gray-600">
            쯏a tienes cuenta? <a href="login.html" class="text-blue-600 font-bold hover:underline">Inicia Sesi칩n aqu칤</a>
        </p>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Variables de estado
        let esProfesor = false;
        const CLAVE_MAESTRA = "Profe-UADY-asist26"; // <--- CONTRASE칌A PARA REGISTRARSE COMO PROFESOR

        // Elementos DOM
        const tabAlumno = document.getElementById('tab-alumno');
        const tabProfesor = document.getElementById('tab-profesor');
        const campoMatricula = document.getElementById('campo-matricula');
        const campoSecreto = document.getElementById('campo-secreto');
        const btnSubmit = document.getElementById('btn-submit');
        const form = document.getElementById('registro-form');
        const errorMsg = document.getElementById('error-msg');

        // L칩gica de Pesta침as
        tabAlumno.addEventListener('click', (e) => {
            e.preventDefault();
            activarModo(false);
        });

        tabProfesor.addEventListener('click', (e) => {
            e.preventDefault();
            activarModo(true);
        });

        function activarModo(modoProfe) {
            esProfesor = modoProfe;
            if (esProfesor) {
                // Estilos Pesta침a
                tabProfesor.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'font-bold');
                tabProfesor.classList.remove('text-gray-500');
                tabAlumno.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'font-bold');
                tabAlumno.classList.add('text-gray-500');
                
                // Campos visibles
                campoMatricula.classList.add('hidden');
                campoSecreto.classList.remove('hidden');
                btnSubmit.innerText = "Registrarme como Profesor";
                btnSubmit.classList.replace('bg-blue-600', 'bg-orange-600');
                btnSubmit.classList.replace('hover:bg-blue-700', 'hover:bg-orange-700');
            } else {
                // Estilos Pesta침a
                tabAlumno.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'font-bold');
                tabAlumno.classList.remove('text-gray-500');
                tabProfesor.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'font-bold');
                tabProfesor.classList.add('text-gray-500');

                // Campos visibles
                campoMatricula.classList.remove('hidden');
                campoSecreto.classList.add('hidden');
                btnSubmit.innerText = "Registrarme como Alumno";
                btnSubmit.classList.replace('bg-orange-600', 'bg-blue-600');
                btnSubmit.classList.replace('hover:bg-orange-700', 'hover:bg-blue-700');
            }
        }

        // Manejo del Env칤o
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.classList.add('hidden');

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const nombre = document.getElementById('nombre').value.toUpperCase();
            const matricula = document.getElementById('matricula').value.toUpperCase();
            const claveIngresada = document.getElementById('clave-profe').value;

            // Validaciones
            if (password.length < 6) return mostrarError("La contrase침a debe tener al menos 6 caracteres.");
            
            if (esProfesor) {
                if (claveIngresada !== CLAVE_MAESTRA) return mostrarError("Clave docente incorrecta. No tienes autorizaci칩n.");
            } else {
                if (matricula.length < 4) return mostrarError("Escribe una matr칤cula v치lida.");
            }

            try {
                btnSubmit.disabled = true;
                btnSubmit.innerText = "Creando cuenta...";

                // 1. Crear usuario en Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 2. Guardar datos en Firestore
                await setDoc(doc(db, "usuarios", user.uid), {
                    email: email,
                    nombre: nombre,
                    rol: esProfesor ? "profesor" : "alumno",
                    // Si es profe, no guardamos matr칤cula
                    matricula: esProfesor ? "N/A" : matricula,
                    fecha_registro: new Date()
                });

                alert("춰Cuenta creada con 칠xito!");
                
                // Redirigir seg칰n rol
                if (esProfesor) window.location.href = "generador.html";
                else window.location.href = "escaner.html";

            } catch (error) {
                console.error(error);
                let msg = "Error al crear cuenta: " + error.code;
                if (error.code === 'auth/email-already-in-use') msg = "Ese correo ya est치 registrado.";
                mostrarError(msg);
                btnSubmit.disabled = false;
            }
        });

        function mostrarError(msg) {
            errorMsg.innerText = msg;
            errorMsg.classList.remove('hidden');
        }
    </script>
</body>
</html>