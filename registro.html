<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Sistema UADY</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
        <h1 class="text-2xl font-bold text-center text-blue-900 mb-6">Crear Cuenta Nueva</h1>

        <div class="flex mb-6 border-b">
            <button id="tab-alumno" class="flex-1 py-2 text-blue-600 border-b-2 border-blue-600 font-bold focus:outline-none transition">Soy Alumno</button>
            <button id="tab-profesor" class="flex-1 py-2 text-gray-500 hover:text-blue-600 focus:outline-none transition">Soy Profesor</button>
        </div>

        <form id="registro-form" class="space-y-4">
            
            <div id="campo-nombre" class="hidden">
                <label class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                <input type="text" id="nombre" class="w-full p-2 border rounded bg-gray-50 uppercase" placeholder="JUAN P√âREZ">
            </div>

            <div id="campo-matricula">
                <label class="block text-sm font-medium text-gray-700">Matr√≠cula</label>
                <input type="text" id="matricula" class="w-full p-2 border rounded bg-gray-50 uppercase" placeholder="A13214898">
                <p class="text-[10px] text-gray-400 mt-1">Puedes ingresar tu matr√≠cula con o sin la letra "A".</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Correo Institucional</label>
                <input type="email" id="email" required class="w-full p-2 border rounded bg-gray-50" placeholder="usuario@correo.uady.mx">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Contrase√±a (M√≠n. 6 caracteres)</label>
                <input type="password" id="password" required class="w-full p-2 border rounded bg-gray-50" placeholder="******">
            </div>

            <div id="campo-secreto" class="hidden bg-yellow-50 p-3 rounded border border-yellow-200">
                <label class="block text-sm font-bold text-yellow-800">üîí Clave de Autenticaci√≥n Docente</label>
                <input type="password" id="clave-profe" class="w-full p-2 border rounded mt-1" placeholder="Solo personal autorizado">
            </div>

            <div id="error-msg" class="text-red-500 text-sm text-center hidden font-bold"></div>

            <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition shadow-lg">
                Registrarme como Alumno
            </button>
        </form>

        <p class="text-center mt-4 text-sm text-gray-600">
            ¬øYa tienes cuenta? <a href="login.html" class="text-blue-600 font-bold hover:underline">Inicia Sesi√≥n aqu√≠</a>
        </p>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let esProfesor = false;
        const CLAVE_MAESTRA = "Profe-UADY-asist26"; 

        const tabAlumno = document.getElementById('tab-alumno');
        const tabProfesor = document.getElementById('tab-profesor');
        const campoNombre = document.getElementById('campo-nombre');
        const campoMatricula = document.getElementById('campo-matricula');
        const campoSecreto = document.getElementById('campo-secreto');
        const btnSubmit = document.getElementById('btn-submit');
        const errorMsg = document.getElementById('error-msg');
        const form = document.getElementById('registro-form');

        tabAlumno.addEventListener('click', (e) => { e.preventDefault(); activarModo(false); });
        tabProfesor.addEventListener('click', (e) => { e.preventDefault(); activarModo(true); });

        function activarModo(modoProfe) {
            esProfesor = modoProfe;
            errorMsg.classList.add('hidden');
            if (esProfesor) {
                tabProfesor.className = "flex-1 py-2 text-blue-600 border-b-2 border-blue-600 font-bold focus:outline-none transition";
                tabAlumno.className = "flex-1 py-2 text-gray-500 hover:text-blue-600 focus:outline-none transition";
                campoNombre.classList.remove('hidden');
                campoMatricula.classList.add('hidden');
                campoSecreto.classList.remove('hidden');
                btnSubmit.innerText = "Registrarme como Profesor";
                btnSubmit.className = "w-full bg-orange-600 text-white py-3 rounded font-bold hover:bg-orange-700 transition shadow-lg";
            } else {
                tabAlumno.className = "flex-1 py-2 text-blue-600 border-b-2 border-blue-600 font-bold focus:outline-none transition";
                tabProfesor.className = "flex-1 py-2 text-gray-500 hover:text-blue-600 focus:outline-none transition";
                campoNombre.classList.add('hidden');
                campoMatricula.classList.remove('hidden');
                campoSecreto.classList.add('hidden');
                btnSubmit.innerText = "Registrarme como Alumno";
                btnSubmit.className = "w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition shadow-lg";
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.classList.add('hidden');

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const matriculaInput = document.getElementById('matricula').value.trim();
            const nombreIngresado = document.getElementById('nombre').value.toUpperCase().trim();
            const claveIngresada = document.getElementById('clave-profe').value;

            try {
                btnSubmit.disabled = true;
                btnSubmit.innerText = "Verificando...";

                let nombreFinal = nombreIngresado;
                let matriculaLimpia = "";

                if (!esProfesor) {
                    if (!matriculaInput) throw new Error("Por favor, ingresa tu matr√≠cula.");

                    // --- LIMPIEZA DE MATR√çCULA ---
                    // Esta l√≠nea elimina cualquier letra o s√≠mbolo, dejando solo los n√∫meros.
                    matriculaLimpia = matriculaInput.replace(/\D/g, ''); 

                    // Consulta en Firestore buscando la parte num√©rica
                    const q = query(collection(db, "padron_alumnos"), where("matricula", "==", matriculaLimpia));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        throw new Error("Padr√≥n no encontrado");
                    }

                    const datosAlumno = querySnapshot.docs[0].data();
                    nombreFinal = datosAlumno.nombre_oficial;
                } else {
                    if (claveIngresada !== CLAVE_MAESTRA) throw new Error("Clave docente incorrecta.");
                    if (!nombreFinal) throw new Error("Por favor, ingresa tu nombre.");
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, "usuarios", user.uid), {
                    email: email,
                    nombre: nombreFinal,
                    rol: esProfesor ? "profesor" : "alumno",
                    // Guardamos la matr√≠cula limpia (solo n√∫meros) para consistencia
                    matricula: esProfesor ? "N/A" : matriculaLimpia,
                    fecha_registro: new Date()
                });

                alert("¬°Bienvenido, " + nombreFinal + "!");
                window.location.href = esProfesor ? "generador.html" : "escaner.html";

            } catch (error) {
                console.error(error);
                let msg = "Error al registrar.";
                if (error.message === "Padr√≥n no encontrado") msg = "üö´ Matr√≠cula no autorizada o no encontrada en el padr√≥n.";
                else if (error.message === "Clave docente incorrecta.") msg = "Clave docente incorrecta.";
                else if (error.code === 'auth/email-already-in-use') msg = "Este correo ya est√° registrado.";
                
                mostrarError(msg);
                btnSubmit.disabled = false;
                btnSubmit.innerText = esProfesor ? "Registrarme como Profesor" : "Registrarme como Alumno";
            }
        });

        function mostrarError(msg) {
            errorMsg.innerHTML = msg;
            errorMsg.classList.remove('hidden');
        }
    </script>
</body>
</html>
